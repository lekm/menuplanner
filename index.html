<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Meal Planner - Auth Enabled</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuration -->
    <script>
    // EmailJS configuration
    window.VITE_EMAILJS_USER_ID = 'yyKfiq-hIQgATGWPi';
    window.VITE_EMAILJS_SERVICE_ID = 'service_0jfc4xc';
    window.VITE_EMAILJS_TEMPLATE_ID = 'template_0ta7il9';
    
    // Supabase configuration
    window.VITE_SUPABASE_URL = 'https://vriusyvuqwlozqqcpbke.supabase.co';
    window.VITE_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyaXVzeXZ1cXdsb3pxcWNwYmtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzOTQwMDEsImV4cCI6MjA2Nzk3MDAwMX0.AoKGvVhxDzAaYOAgSVwt4Jhve9-Ck4o2BiD3iHiV8oE';
    
    // Hugging Face configuration - set via Vercel environment variables
    // window.VITE_HUGGINGFACE_TOKEN will be injected by Vercel if configured
    
    // Debug Supabase loading
    console.log('Supabase URL:', window.VITE_SUPABASE_URL);
    console.log('Supabase Key present:', !!window.VITE_SUPABASE_ANON_KEY);
    console.log('Supabase global:', !!window.supabase);
    </script>
    
    <!-- Load our API layer and bug reporting system -->
    <script src="js/api.js"></script>
    <script src="js/bug-report.js"></script>
    <style>
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: .8;
      }
    }
    .icon-btn.selected {
        background-color: #3b82f6;
        color: white;
    }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading fallback in case JS fails -->
    <div id="loading-fallback" class="fixed inset-0 bg-blue-500 flex items-center justify-center text-white text-xl">
        Loading...
    </div>
    
    <div id="main-app" class="w-full px-2 py-4 hidden">
        <!-- Header with Auth -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl md:text-4xl font-bold text-gray-800">Weekly Meal Planner</h1>
            
            <!-- Auth Section -->
            <div id="auth-section" class="flex items-center gap-2">
                <!-- User Info (when logged in) -->
                <div id="user-info" class="hidden flex items-center gap-2">
                    <img id="user-avatar" src="" alt="User Avatar" class="w-8 h-8 rounded-full hidden">
                    <span id="user-name" class="text-sm text-gray-700"></span>
                    <button onclick="showUserMenu()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Login Button (when not logged in) -->
                <button id="login-btn" onclick="showAuthModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-200">
                    Login
                </button>
                
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg shadow-md p-1 flex flex-wrap">
                <button onclick="switchTab('planner')" id="tab-planner" class="px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors bg-blue-500 text-white">üìÖ Planner</button>
                <button onclick="switchTab('recipes')" id="tab-recipes" class="px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors text-gray-700 hover:bg-gray-100">üìñ My Recipes</button>
                <button onclick="switchTab('browse')" id="tab-browse" class="px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors text-gray-700 hover:bg-gray-100">üåê Browse Recipes</button>
                <button onclick="switchTab('templates')" id="tab-templates" class="px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors text-gray-700 hover:bg-gray-100">üìã Templates</button>
            </div>
        </div>
        
        <!-- Planner Tab Content -->
        <div id="planner-content">
        
        <!-- Energy Level Selector -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg shadow-md p-2 md:p-4 flex flex-wrap gap-2 md:gap-4">
                <span class="text-xs md:text-sm font-medium text-gray-700 self-center w-full md:w-auto text-center md:text-left">Today's Energy:</span>
                <button onclick="setEnergyLevel('high')" id="energy-high" class="px-3 py-2 md:px-4 rounded-md text-xs md:text-sm font-medium transition-colors bg-green-100 text-green-800 hover:bg-green-200 flex-1 md:flex-none">üöÄ High Energy</button>
                <button onclick="setEnergyLevel('medium')" id="energy-medium" class="px-3 py-2 md:px-4 rounded-md text-xs md:text-sm font-medium transition-colors bg-yellow-100 text-yellow-800 hover:bg-yellow-200 flex-1 md:flex-none">‚ö° Medium Energy</button>
                <button onclick="setEnergyLevel('low')" id="energy-low" class="px-3 py-2 md:px-4 rounded-md text-xs md:text-sm font-medium transition-colors bg-red-100 text-red-800 hover:bg-red-200 flex-1 md:flex-none">üò¥ Survival Mode</button>
            </div>
        </div>
        
        <!-- Meal Suggestions Panel -->
        <div id="suggestions-panel" class="hidden mb-6 mx-auto max-w-4xl">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-900 mb-2">Suggested Meals for Your Energy Level:</h3>
                <div id="suggestions-content" class="text-sm text-blue-800"></div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-2 w-full">
            <!-- Monday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-red-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Monday</h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tuesday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-orange-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Tuesday <span class="text-xs text-green-600">(WFH)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wednesday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-yellow-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Wednesday</h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thursday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-green-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Thursday</h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Friday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-blue-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Friday <span class="text-xs text-orange-600">(WFH‚ÜíBar)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Pre-Bar Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Quick meal before bar shift..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saturday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-indigo-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Saturday <span class="text-xs text-red-600">(Bar Day)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Late Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Recovery breakfast..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Pre-Bar Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Quick meal before bar shift..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sunday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-violet-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Sunday <span class="text-xs text-blue-600">(Recovery)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Late Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Recovery breakfast..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">üìñ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save/Clear buttons -->
        <div class="flex flex-wrap justify-center mt-8 gap-2">
            <button 
                onclick="saveMealPlan()" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                üíæ Save Plan
            </button>
            <button 
                onclick="clearMealPlan()" 
                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                üóëÔ∏è Clear All
            </button>
            <button 
                onclick="generateGroceryList()" 
                class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                üõí Grocery List
            </button>
            <button 
                onclick="saveAsTemplate()" 
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                üìã Save Template
            </button>
        </div>
        
        </div> <!-- End Planner Content -->
        
        <!-- Recipes Tab Content -->
        <div id="recipes-content" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">My Recipe Collection</h2>
                    <button onclick="showAddRecipeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        ‚ûï Add Recipe
                    </button>
                </div>
                
                <!-- Recipe Search -->
                <div class="mb-4">
                    <input type="text" id="my-recipe-search" placeholder="Search recipes..." onkeyup="filterRecipes()" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Recipe Grid -->
                <div id="recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Recipes will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Templates Tab Content -->
        <div id="templates-content" class="hidden">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center">Weekly Meal Templates</h2>
                
                <!-- Pre-built Templates -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="built-in-templates">
                    <!-- Templates will be populated here -->
                </div>
                
                <!-- Saved Templates -->
                <div id="saved-templates">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Your Saved Templates</h3>
                    <div id="saved-templates-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- User templates will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Browse Recipes Tab Content -->
        <div id="browse-content" class="hidden">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center">Browse RecipeTin Eats Recipes</h2>
                
                <!-- Category Filters -->
                <div class="mb-6 bg-white rounded-lg shadow-md p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">Browse by Category</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                        <!-- Cuisine Types -->
                        <button onclick="browseCategory('asian')" class="category-btn bg-red-100 hover:bg-red-200 text-red-800 px-3 py-2 rounded-md text-sm transition-colors">ü•¢ Asian</button>
                        <button onclick="browseCategory('italian')" class="category-btn bg-green-100 hover:bg-green-200 text-green-800 px-3 py-2 rounded-md text-sm transition-colors">üçù Italian</button>
                        <button onclick="browseCategory('mexican')" class="category-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-2 rounded-md text-sm transition-colors">üåÆ Mexican</button>
                        <button onclick="browseCategory('indian')" class="category-btn bg-orange-100 hover:bg-orange-200 text-orange-800 px-3 py-2 rounded-md text-sm transition-colors">üçõ Indian</button>
                        <button onclick="browseCategory('greek')" class="category-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-2 rounded-md text-sm transition-colors">üá¨üá∑ Greek</button>
                        <button onclick="browseCategory('french')" class="category-btn bg-purple-100 hover:bg-purple-200 text-purple-800 px-3 py-2 rounded-md text-sm transition-colors">üá´üá∑ French</button>
                        
                        <!-- Meal Types -->
                        <button onclick="browseCategory('chicken')" class="category-btn bg-amber-100 hover:bg-amber-200 text-amber-800 px-3 py-2 rounded-md text-sm transition-colors">üêî Chicken</button>
                        <button onclick="browseCategory('beef')" class="category-btn bg-red-100 hover:bg-red-200 text-red-800 px-3 py-2 rounded-md text-sm transition-colors">ü•© Beef</button>
                        <button onclick="browseCategory('seafood')" class="category-btn bg-cyan-100 hover:bg-cyan-200 text-cyan-800 px-3 py-2 rounded-md text-sm transition-colors">üêü Seafood</button>
                        <button onclick="browseCategory('vegetarian')" class="category-btn bg-green-100 hover:bg-green-200 text-green-800 px-3 py-2 rounded-md text-sm transition-colors">ü•¨ Vegetarian</button>
                        <button onclick="browseCategory('pasta')" class="category-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-2 rounded-md text-sm transition-colors">üçú Pasta</button>
                        <button onclick="browseCategory('desserts')" class="category-btn bg-pink-100 hover:bg-pink-200 text-pink-800 px-3 py-2 rounded-md text-sm transition-colors">üç∞ Desserts</button>
                        
                        <!-- Cooking Methods -->
                        <button onclick="browseCategory('slow-cooker')" class="category-btn bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded-md text-sm transition-colors">üç≤ Slow Cooker</button>
                        <button onclick="browseCategory('one-pot')" class="category-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-md text-sm transition-colors">ü•ò One Pot</button>
                        <button onclick="browseCategory('stir-fries')" class="category-btn bg-rose-100 hover:bg-rose-200 text-rose-800 px-3 py-2 rounded-md text-sm transition-colors">ü•ó Stir Fries</button>
                        <button onclick="browseCategory('soups')" class="category-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-2 rounded-md text-sm transition-colors">üçú Soups</button>
                        <button onclick="browseCategory('salads')" class="category-btn bg-green-100 hover:bg-green-200 text-green-800 px-3 py-2 rounded-md text-sm transition-colors">ü•ó Salads</button>
                        <button onclick="browseCategory('breakfast')" class="category-btn bg-orange-100 hover:bg-orange-200 text-orange-800 px-3 py-2 rounded-md text-sm transition-colors">üç≥ Breakfast</button>
                    </div>
                </div>

                <!-- Search -->
                <div class="mb-6 bg-white rounded-lg shadow-md p-4">
                    <div class="flex gap-2">
                        <input type="text" id="browse-recipe-search" placeholder="Search recipes..." class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <button onclick="searchRecipes()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors">üîç Search</button>
                    </div>
                </div>

                <!-- Browse Status -->
                <div id="browse-status" class="hidden mb-4 p-3 rounded-md">
                    <div id="browse-message" class="text-sm"></div>
                </div>

                <!-- Recipe Results -->
                <div id="recipe-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="col-span-full text-center text-gray-500 py-8">
                        <p class="text-lg">üçΩÔ∏è Choose a category above to browse recipes</p>
                        <p class="text-sm">Click any category to discover amazing recipes from RecipeTin Eats</p>
                    </div>
                </div>

                <!-- Load More Button -->
                <div id="load-more-container" class="hidden text-center mt-6">
                    <button onclick="loadMoreRecipes()" id="load-more-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">
                        Load More Recipes
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Add Recipe Modal -->
        <div id="add-recipe-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Add New Recipe</h3>
                    <button onclick="hideAddRecipeModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>

                <!-- Import Tabs -->
                <div class="flex mb-4 border-b">
                    <button onclick="showImportTab('manual')" id="manual-tab" class="flex-1 py-2 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        ‚úèÔ∏è Manual Entry
                    </button>
                    <button onclick="showImportTab('url')" id="url-tab" class="flex-1 py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700">
                        üîó Import from URL
                    </button>
                </div>

                <!-- URL Import Section -->
                <div id="url-import-section" class="hidden">
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">Import Recipe from URL</h4>
                        <p class="text-sm text-blue-700 mb-3">
                            Supported sites: RecipeTin Eats, and other sites with structured recipe data
                        </p>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Recipe URL</label>
                            <input type="url" id="import-url" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="https://www.recipetineats.com/recipe-name/">
                        </div>
                        
                        <button type="button" onclick="importRecipeFromUrl()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            üîç Extract Recipe
                        </button>
                        
                        <div id="import-status" class="hidden mt-3 p-2 rounded-md">
                            <div id="import-message" class="text-sm"></div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div id="import-preview" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Recipe Preview</h4>
                        <div id="preview-content">
                            <!-- Preview will be populated here -->
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button type="button" onclick="saveImportedRecipe()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                üíæ Save Recipe
                            </button>
                            <button type="button" onclick="editImportedRecipe()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm">
                                ‚úèÔ∏è Edit First
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Entry Form -->
                <form id="recipe-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Name</label>
                        <input type="text" id="recipe-name" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Energy Level</label>
                        <select id="recipe-energy" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="high">üöÄ High Energy</option>
                            <option value="medium">‚ö° Medium Energy</option>
                            <option value="low">üò¥ Survival Mode</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipment</label>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label><input type="checkbox" value="instant-pot" class="mr-1"> Instant Pot</label>
                            <label><input type="checkbox" value="cast-iron" class="mr-1"> Cast Iron</label>
                            <label><input type="checkbox" value="sous-vide" class="mr-1"> Sous Vide</label>
                            <label><input type="checkbox" value="pizza-oven" class="mr-1"> Pizza Oven</label>
                            <label><input type="checkbox" value="air-fryer" class="mr-1"> Air Fryer</label>
                            <label><input type="checkbox" value="blender" class="mr-1"> Blender</label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cooking Time (minutes)</label>
                        <input type="number" id="recipe-time" min="5" max="300" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ingredients (one per line)</label>
                        <textarea id="recipe-ingredients" rows="6" placeholder="1 lb ground beef&#10;2 tbsp olive oil&#10;1 onion, diced" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
                        <textarea id="recipe-instructions" rows="4" placeholder="Brief cooking instructions..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Icon</label>
                        <div class="grid grid-cols-8 gap-2 text-xl">
                            <button type="button" onclick="selectIcon('üçù')" class="icon-btn p-2 border rounded hover:bg-gray-100">üçù</button>
                            <button type="button" onclick="selectIcon('ü•ó')" class="icon-btn p-2 border rounded hover:bg-gray-100">ü•ó</button>
                            <button type="button" onclick="selectIcon('üçñ')" class="icon-btn p-2 border rounded hover:bg-gray-100">üçñ</button>
                            <button type="button" onclick="selectIcon('üç≤')" class="icon-btn p-2 border rounded hover:bg-gray-100">üç≤</button>
                            <button type="button" onclick="selectIcon('üç≥')" class="icon-btn p-2 border rounded hover:bg-gray-100">üç≥</button>
                            <button type="button" onclick="selectIcon('ü•ò')" class="icon-btn p-2 border rounded hover:bg-gray-100">ü•ò</button>
                            <button type="button" onclick="selectIcon('üçï')" class="icon-btn p-2 border rounded hover:bg-gray-100">üçï</button>
                            <button type="button" onclick="selectIcon('ü•™')" class="icon-btn p-2 border rounded hover:bg-gray-100">ü•™</button>
                        </div>
                        <input type="hidden" id="recipe-icon" value="üçΩÔ∏è">
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save Recipe
                        </button>
                        <button type="button" onclick="hideAddRecipeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition duration-200">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recipe Picker Modal -->
        <div id="recipe-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Choose a Recipe</h3>
                    <button onclick="hideRecipePicker()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="recipe-picker-search" placeholder="Search recipes..." onkeyup="filterRecipePicker()" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div id="recipe-picker-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Recipe options will be populated here -->
                </div>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Welcome to Meal Planner</h3>
                    <button onclick="hideAuthModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>

                <!-- Auth Tabs -->
                <div class="flex mb-4 border-b">
                    <button onclick="showAuthTab('login')" id="login-tab" class="flex-1 py-2 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        Login
                    </button>
                    <button onclick="showAuthTab('signup')" id="signup-tab" class="flex-1 py-2 px-4 text-sm font-medium text-gray-500">
                        Sign Up
                    </button>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="auth-form">
                    <form id="login-form-element" onsubmit="handleEmailSignIn(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="login-email" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="login-password" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 mb-3">
                            Login
                        </button>
                    </form>
                    
                    <div class="text-center mb-3">
                        <span class="text-sm text-gray-500">or</span>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="signInWithProvider('google')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continue with Google
                        </button>
                        <button onclick="signInWithProvider('github')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Continue with GitHub
                        </button>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button onclick="showForgotPassword()" class="text-sm text-blue-600 hover:text-blue-800">
                            Forgot password?
                        </button>
                    </div>
                </div>

                <!-- Sign Up Form -->
                <div id="signup-form" class="auth-form hidden">
                    <form id="signup-form-element" onsubmit="handleEmailSignUp(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" id="signup-name" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="signup-email" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="signup-password" required minlength="6" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <div class="text-xs text-gray-500 mt-1">At least 6 characters</div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 mb-3">
                            Create Account
                        </button>
                    </form>
                    
                    <div class="text-center mb-3">
                        <span class="text-sm text-gray-500">or</span>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="signInWithProvider('google')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Sign up with Google
                        </button>
                        <button onclick="signInWithProvider('github')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Sign up with GitHub
                        </button>
                    </div>
                </div>

                <!-- Auth Messages -->
                <div id="auth-message" class="hidden mt-4 p-3 rounded-md">
                    <div id="auth-message-text" class="text-sm"></div>
                </div>
            </div>
        </div>

        <!-- User Menu Dropdown -->
        <div id="user-menu" class="hidden fixed top-16 right-4 bg-white rounded-lg shadow-lg border z-50 min-w-48">
            <div class="py-2">
                <div class="px-4 py-2 border-b">
                    <div class="text-sm font-medium text-gray-900" id="menu-user-name"></div>
                    <div class="text-sm text-gray-500" id="menu-user-email"></div>
                </div>
                <button onclick="showProfileModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    ‚öôÔ∏è Profile Settings
                </button>
                <button onclick="exportData()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    üì§ Export Data
                </button>
                <button onclick="importData()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    üì• Import Data
                </button>
                <div class="border-t">
                    <button onclick="signOut()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                        üö™ Sign Out
                    </button>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">User Profile</h3>
                    <button onclick="hideProfileModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>

                <!-- Profile Header -->
                <div class="flex items-center space-x-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="relative">
                        <img id="profile-avatar" src="" alt="Profile Picture" class="w-16 h-16 rounded-full border-2 border-gray-200 hidden">
                        <div id="profile-avatar-placeholder" class="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-white text-xl font-semibold">
                            ?
                        </div>
                    </div>
                    <div>
                        <h4 id="profile-name" class="text-lg font-semibold text-gray-800"></h4>
                        <p id="profile-email" class="text-sm text-gray-600"></p>
                        <p id="profile-provider" class="text-xs text-gray-500"></p>
                    </div>
                </div>

                <!-- Profile Form -->
                <form id="profile-form" onsubmit="saveProfile(event)">
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" id="profile-display-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Avatar URL (Optional)</label>
                            <input type="url" id="profile-avatar-url" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="https://...">
                        </div>
                    </div>

                    <!-- Cooking Equipment -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cooking Equipment</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="Instant Pot" class="equipment-checkbox mr-2">
                                <span class="text-sm">Instant Pot</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Cast Iron" class="equipment-checkbox mr-2">
                                <span class="text-sm">Cast Iron</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Stand Mixer" class="equipment-checkbox mr-2">
                                <span class="text-sm">Stand Mixer</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Sous Vide" class="equipment-checkbox mr-2">
                                <span class="text-sm">Sous Vide</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Pizza Oven" class="equipment-checkbox mr-2">
                                <span class="text-sm">Pizza Oven</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Mandoline" class="equipment-checkbox mr-2">
                                <span class="text-sm">Mandoline</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Nutribullet" class="equipment-checkbox mr-2">
                                <span class="text-sm">Nutribullet</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Air Fryer" class="equipment-checkbox mr-2">
                                <span class="text-sm">Air Fryer</span>
                            </label>
                        </div>
                    </div>

                    <!-- Dietary Restrictions -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dietary Restrictions</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="Vegetarian" class="dietary-checkbox mr-2">
                                <span class="text-sm">Vegetarian</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Vegan" class="dietary-checkbox mr-2">
                                <span class="text-sm">Vegan</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Gluten-Free" class="dietary-checkbox mr-2">
                                <span class="text-sm">Gluten-Free</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Dairy-Free" class="dietary-checkbox mr-2">
                                <span class="text-sm">Dairy-Free</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Keto" class="dietary-checkbox mr-2">
                                <span class="text-sm">Keto</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Low-Carb" class="dietary-checkbox mr-2">
                                <span class="text-sm">Low-Carb</span>
                            </label>
                        </div>
                    </div>

                    <!-- Password Change Section (for email users) -->
                    <div id="password-section" class="mb-6 hidden">
                        <h5 class="text-lg font-medium text-gray-800 mb-3">Change Password</h5>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" id="new-password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" minlength="6">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                                <input type="password" id="confirm-password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" minlength="6">
                            </div>
                        </div>
                        <button type="button" onclick="changePassword()" class="mt-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md text-sm">
                            Update Password
                        </button>
                    </div>

                    <!-- OAuth Connection Info -->
                    <div id="oauth-section" class="mb-6 hidden">
                        <h5 class="text-lg font-medium text-gray-800 mb-3">OAuth Connection</h5>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                            <div class="flex items-center space-x-2">
                                <div id="oauth-provider-icon"></div>
                                <div>
                                    <p class="text-sm font-medium" id="oauth-provider-text"></p>
                                    <p class="text-xs text-gray-600">Connected via OAuth</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Actions -->
                    <div class="flex flex-wrap gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save Changes
                        </button>
                        <button type="button" onclick="migrateLocalData()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                            Migrate Local Data
                        </button>
                        <button type="button" onclick="signOut()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm">
                            Sign Out
                        </button>
                    </div>
                </form>

                <!-- Success/Error Messages -->
                <div id="profile-success" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-md">
                    <div class="text-green-800 text-sm">‚úÖ Profile updated successfully!</div>
                </div>
                <div id="profile-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
                    <div class="text-red-800 text-sm">‚ùå <span id="profile-error-message">Failed to update profile.</span></div>
                </div>
            </div>
        </div>

        <!-- Floating Bug Report Button -->
        <div class="fixed bottom-6 right-6 z-40">
            <button onclick="showBugReportModal()" title="Report bugs, request features, or give feedback" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2 group hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span class="hidden md:inline-block text-sm">Report Bug</span>
                <span class="md:hidden text-xs">Report</span>
            </button>
        </div>

    </div>

    <!-- Authentication Gate -->
    <div id="auth-gate" class="fixed inset-0 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center z-50">
        <div class="max-w-md w-full mx-4">
            <div class="text-center text-white mb-8">
                <div class="text-6xl mb-4">üçΩÔ∏è</div>
                <h1 class="text-4xl font-bold mb-4">Welcome to<br>Meal Planner</h1>
                <p class="text-xl opacity-90 mb-8">Your personal cooking assistant awaits! Create an account to start planning amazing meals tailored just for you.</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-xl">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2">Get Started</h2>
                    <p class="text-gray-600">Sign up to unlock personalized meal planning</p>
                </div>
                
                <div class="space-y-4">
                    <!-- Email Auth Options -->
                    <div class="space-y-3">
                        <button onclick="showAuthModal('signup')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                            ‚ú® Create Account with Email
                        </button>
                        <button onclick="showAuthModal('login')" class="w-full bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-semibold py-3 px-4 rounded-lg transition duration-200">
                            üîë Sign In with Email
                        </button>
                    </div>
                    
                    <!-- Divider -->
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">Or continue with</span>
                        </div>
                    </div>
                    
                    <!-- OAuth Options -->
                    <div class="space-y-3">
                        <button onclick="signInWithProvider('google')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            <span>Google</span>
                        </button>
                        
                        <button onclick="signInWithProvider('github')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            <span>GitHub</span>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- AI Onboarding Modal -->
    <div id="onboarding-modal" class="hidden fixed inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-2xl">
                            ü§ñ
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">AI Setup Assistant</h3>
                            <p class="text-gray-600">Let's create your personalized meal planning profile</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="useTestData()" class="px-3 py-1 text-sm bg-green-500 hover:bg-green-600 rounded text-white transition-colors">
                            ‚ö° Test Data
                        </button>
                        <button onclick="resetOnboarding()" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors">
                            üîÑ Reset
                        </button>
                        <button onclick="logoutAndExit()" class="px-3 py-1 text-sm bg-red-200 hover:bg-red-300 rounded text-red-700 transition-colors">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="onboarding-chat" class="flex-1 p-8 overflow-y-auto">
                <!-- Chat messages will be added here -->
            </div>
            
            <div class="p-6 border-t bg-gray-50">
                <div class="flex justify-center">
                    <p class="text-sm text-gray-500 flex items-center gap-2">
                        üîí Your responses help us personalize your meal planning experience
                        <span class="text-gray-300">‚Ä¢</span>
                        <span id="onboarding-progress" class="text-blue-600 font-medium">Step 1 of 6</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTextarea = null;
        let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
        let savedTemplates = JSON.parse(localStorage.getItem('savedTemplates')) || [];
        
        // Energy-based meal suggestions tailored to your lifestyle
        const mealSuggestions = {
            high: {
                title: "High Energy - Time to Cook! üöÄ",
                meals: [
                    "üçñ Instant Pot Lamb Ragu (batch cook for freezing)",
                    "üçï Homemade pizza with your benchtop oven",
                    "ü•© Sous vide steak with elaborate sides",
                    "üçõ Complex curry using your 48-spice collection",
                    "üçù Fresh pasta from scratch with stand mixer",
                    "üêü Pan-seared fish with roasted vegetables",
                    "üç≤ Cast iron braised short ribs",
                    "ü•ò Moroccan tagine with preserved lemons"
                ]
            },
            medium: {
                title: "Medium Energy - Solid Cooking ‚ö°",
                meals: [
                    "üç≥ Quick stir-fry with whatever vegetables you have",
                    "üçù One-pot pasta with herbs from your spice collection",
                    "üçõ Simple curry using pre-made spice blends",
                    "üçó Cast iron chicken thighs with minimal prep",
                    "üåØ Good wraps with quality fillings",
                    "üçú Upgraded instant ramen with proper toppings",
                    "ü•ó Mandoline-sliced salad with protein",
                    "üç≥ Fancy scrambled eggs with herbs"
                ]
            },
            low: {
                title: "Survival Mode - Avoid Uber Eats! üò¥",
                meals: [
                    "üçû Fancy toast (good bread + simple toppings)",
                    "ü•ó Pre-made salad with protein you have on hand",
                    "üçù Pasta with quality jarred sauce + cheese",
                    "ü•™ Upgraded sandwiches with good ingredients",
                    "üç≤ Heat up frozen Dinner Ladies meal",
                    "ü•§ Nutribullet smoothie bowl with nuts/seeds",
                    "üßÄ Cheese and crackers with fruit",
                    "ü•£ Good cereal or overnight oats"
                ]
            }
        };

        // Built-in templates
        const builtInTemplates = [
            {
                name: "High Energy Week",
                description: "For when you're motivated to cook complex meals",
                meals: {
                    Monday: { Breakfast: "ü•£ Overnight oats with fruit", Lunch: "ü•ó Grain bowl with protein", Dinner: "üçñ Instant Pot Lamb Ragu" },
                    Tuesday: { Breakfast: "üç≥ Veggie scramble", Lunch: "üåØ Leftover ragu wrap", Dinner: "üçï Homemade pizza" },
                    Wednesday: { Breakfast: "ü•§ Green smoothie", Lunch: "üçï Pizza leftovers", Dinner: "ü•© Sous vide steak" },
                    Thursday: { Breakfast: "üçû Avocado toast", Lunch: "ü•ó Steak salad", Dinner: "üçõ Complex curry" },
                    Friday: { Breakfast: "ü•£ Yogurt parfait", Lunch: "üçõ Curry leftovers", "Pre-Bar Dinner": "üç≥ Quick pasta" },
                    Saturday: { "Late Breakfast": "ü•û Weekend pancakes", Lunch: "ü•™ Deli sandwich", "Pre-Bar Dinner": "ü•ò Moroccan tagine" },
                    Sunday: { "Late Breakfast": "üç≥ Big breakfast", Lunch: "ü•ò Tagine leftovers", Dinner: "üç≤ Cast iron short ribs" }
                }
            },
            {
                name: "Survival Mode Week", 
                description: "Low energy, anti-takeaway options",
                meals: {
                    Monday: { Breakfast: "ü•£ Good cereal", Lunch: "ü•™ Quality sandwich", Dinner: "üçù Pasta with jarred sauce" },
                    Tuesday: { Breakfast: "üçû Fancy toast", Lunch: "ü•ó Pre-made salad", Dinner: "üç≤ Dinner Ladies meal" },
                    Wednesday: { Breakfast: "ü•§ Smoothie", Lunch: "üçù Pasta leftovers", Dinner: "üßÄ Cheese and crackers" },
                    Thursday: { Breakfast: "ü•£ Overnight oats", Lunch: "ü•™ Another sandwich", Dinner: "ü•ó Salad with protein" },
                    Friday: { Breakfast: "üçû Toast", Lunch: "ü•§ Smoothie bowl", "Pre-Bar Dinner": "üçù Quick pasta" },
                    Saturday: { "Late Breakfast": "ü•£ Recovery cereal", Lunch: "ü•™ Easy wrap", "Pre-Bar Dinner": "üç≤ Microwave meal" },
                    Sunday: { "Late Breakfast": "üçû Comfort toast", Lunch: "üßÄ Cheese board", Dinner: "ü•ó Simple salad" }
                }
            }
        ];

        // Tab switching
        function switchTab(tabName) {
            // Hide all content
            document.getElementById('planner-content').classList.add('hidden');
            document.getElementById('recipes-content').classList.add('hidden');
            document.getElementById('browse-content').classList.add('hidden');
            document.getElementById('templates-content').classList.add('hidden');
            
            // Show selected content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
            
            document.getElementById('tab-' + tabName).classList.add('bg-blue-500', 'text-white');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-700', 'hover:bg-gray-100');
            
            // Load content if needed
            if (tabName === 'recipes') {
                loadRecipes();
            } else if (tabName === 'templates') {
                loadTemplates();
            }
        }

        function setEnergyLevel(level) {
            // Update button states
            document.querySelectorAll('[id^="energy-"]').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
                if (btn.id === `energy-${level}`) {
                    btn.classList.add('ring-2', 'ring-offset-2', level === 'high' ? 'ring-green-500' : level === 'medium' ? 'ring-yellow-500' : 'ring-red-500');
                }
            });

            // Show suggestions
            const panel = document.getElementById('suggestions-panel');
            const content = document.getElementById('suggestions-content');
            const suggestions = mealSuggestions[level];
            
            content.innerHTML = `
                <div class="font-medium mb-2">${suggestions.title}</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    ${suggestions.meals.map(meal => `<div class="cursor-pointer hover:bg-blue-100 p-2 rounded transition-colors" onclick="quickAddMeal('${meal.replace(/'/g, "\\\\'")}')">&bull; ${meal}</div>`).join('')}
                </div>
                <div class="mt-3 text-xs text-blue-600">üí° Click any meal to quickly add it to your planner</div>
            `;
            
            panel.classList.remove('hidden');
        }

        function quickAddMeal(meal) {
            // Find the first empty textarea and add the meal
            const textareas = document.querySelectorAll('#planner-content textarea');
            for (let textarea of textareas) {
                if (!textarea.value.trim()) {
                    textarea.value = meal;
                    textarea.focus();
                    break;
                }
            }
        }

        // Recipe management
        function showAddRecipeModal() {
            document.getElementById('add-recipe-modal').classList.remove('hidden');
        }

        function hideAddRecipeModal() {
            document.getElementById('add-recipe-modal').classList.add('hidden');
            document.getElementById('recipe-form').reset();
        }

        function selectIcon(icon) {
            document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('recipe-icon').value = icon;
        }

        document.getElementById('recipe-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const equipment = Array.from(document.querySelectorAll('#add-recipe-modal input[type="checkbox"]:checked')).map(cb => cb.value);
            
            const recipe = {
                id: Date.now(),
                name: document.getElementById('recipe-name').value,
                energy: document.getElementById('recipe-energy').value,
                equipment: equipment,
                time: document.getElementById('recipe-time').value,
                ingredients: document.getElementById('recipe-ingredients').value.split('\n').filter(i => i.trim()),
                instructions: document.getElementById('recipe-instructions').value,
                icon: document.getElementById('recipe-icon').value || 'üçΩÔ∏è'
            };
            
            recipes.push(recipe);
            localStorage.setItem('recipes', JSON.stringify(recipes));
            loadRecipes();
            hideAddRecipeModal();
        });

        function loadRecipes() {
            const grid = document.getElementById('recipes-grid');
            if (recipes.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No recipes yet. Add your first recipe!</div>';
                return;
            }
            
            grid.innerHTML = recipes.map(recipe => `
                <div class="bg-white rounded-lg shadow-md p-4 border hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-2xl">${recipe.icon}</div>
                        <div class="flex gap-1">
                            <button onclick="useRecipe('${recipe.name}')" class="text-blue-500 hover:text-blue-700 text-sm">Use</button>
                            <button onclick="deleteRecipe(${recipe.id})" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </div>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-1">${recipe.name}</h3>
                    <div class="text-xs text-gray-600 mb-2">
                        ${recipe.energy === 'high' ? 'üöÄ High Energy' : recipe.energy === 'medium' ? '‚ö° Medium Energy' : 'üò¥ Survival Mode'}
                        ${recipe.time ? ` ‚Ä¢ ${recipe.time} min` : ''}
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        ${recipe.equipment.length > 0 ? recipe.equipment.join(', ') : 'No special equipment'}
                    </div>
                    <div class="text-sm text-gray-700 mb-2">
                        <strong>Ingredients:</strong> ${recipe.ingredients.slice(0, 3).join(', ')}${recipe.ingredients.length > 3 ? '...' : ''}
                    </div>
                    ${recipe.instructions ? `<div class="text-sm text-gray-600">${recipe.instructions.substring(0, 100)}${recipe.instructions.length > 100 ? '...' : ''}</div>` : ''}
                </div>
            `).join('');
        }

        function filterRecipes() {
            const search = document.getElementById('my-recipe-search').value.toLowerCase();
            const filteredRecipes = recipes.filter(recipe => 
                recipe.name.toLowerCase().includes(search) ||
                recipe.ingredients.some(ing => ing.toLowerCase().includes(search))
            );
            
            const grid = document.getElementById('recipes-grid');
            grid.innerHTML = filteredRecipes.map(recipe => `
                <div class="bg-white rounded-lg shadow-md p-4 border hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-2xl">${recipe.icon}</div>
                        <div class="flex gap-1">
                            <button onclick="useRecipe('${recipe.name}')" class="text-blue-500 hover:text-blue-700 text-sm">Use</button>
                            <button onclick="deleteRecipe(${recipe.id})" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </div>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-1">${recipe.name}</h3>
                    <div class="text-xs text-gray-600 mb-2">
                        ${recipe.energy === 'high' ? 'üöÄ High Energy' : recipe.energy === 'medium' ? '‚ö° Medium Energy' : 'üò¥ Survival Mode'}
                        ${recipe.time ? ` ‚Ä¢ ${recipe.time} min` : ''}
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        ${recipe.equipment.length > 0 ? recipe.equipment.join(', ') : 'No special equipment'}
                    </div>
                    <div class="text-sm text-gray-700 mb-2">
                        <strong>Ingredients:</strong> ${recipe.ingredients.slice(0, 3).join(', ')}${recipe.ingredients.length > 3 ? '...' : ''}
                    </div>
                    ${recipe.instructions ? `<div class="text-sm text-gray-600">${recipe.instructions.substring(0, 100)}${recipe.instructions.length > 100 ? '...' : ''}</div>` : ''}
                </div>
            `).join('');
        }

        function deleteRecipe(id) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                recipes = recipes.filter(r => r.id !== id);
                localStorage.setItem('recipes', JSON.stringify(recipes));
                loadRecipes();
            }
        }

        function useRecipe(recipeName) {
            const textareas = document.querySelectorAll('#planner-content textarea');
            for (let textarea of textareas) {
                if (!textarea.value.trim()) {
                    textarea.value = recipeName;
                    textarea.focus();
                    switchTab('planner');
                    break;
                }
            }
        }

        // Recipe picker
        function showRecipePicker(button) {
            currentTextarea = button.parentElement.querySelector('textarea');
            document.getElementById('recipe-picker-modal').classList.remove('hidden');
            loadRecipePicker();
        }

        function hideRecipePicker() {
            document.getElementById('recipe-picker-modal').classList.add('hidden');
            currentTextarea = null;
        }

        function loadRecipePicker() {
            const grid = document.getElementById('recipe-picker-grid');
            const allOptions = [...recipes.map(r => ({ name: r.name, icon: r.icon, type: 'recipe' }))];
            
            // Add energy-based suggestions
            Object.entries(mealSuggestions).forEach(([energy, data]) => {
                data.meals.forEach(meal => {
                    allOptions.push({ name: meal, icon: 'üí°', type: 'suggestion' });
                });
            });
            
            grid.innerHTML = allOptions.map(option => `
                <div class="bg-gray-50 hover:bg-blue-50 p-3 rounded-lg cursor-pointer border transition-colors" 
                     onclick="selectRecipeOption('${option.name.replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${option.icon}</span>
                        <span class="text-sm">${option.name}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectRecipeOption(name) {
            if (currentTextarea) {
                currentTextarea.value = name;
                hideRecipePicker();
            }
        }

        function filterRecipePicker() {
            const search = document.getElementById('recipe-picker-search').value.toLowerCase();
            const options = document.querySelectorAll('#recipe-picker-grid > div');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(search)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Templates
        function loadTemplates() {
            const builtInGrid = document.getElementById('built-in-templates');
            builtInGrid.innerHTML = builtInTemplates.map(template => `
                <div class="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                    <h3 class="font-semibold text-gray-800 mb-2">${template.name}</h3>
                    <p class="text-sm text-gray-600 mb-4">${template.description}</p>
                    <button onclick="loadTemplate('${template.name}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Load Template
                    </button>
                </div>
            `).join('');
            
            const savedGrid = document.getElementById('saved-templates-grid');
            if (savedTemplates.length === 0) {
                savedGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No saved templates yet.</div>';
            } else {
                savedGrid.innerHTML = savedTemplates.map(template => `
                    <div class="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                        <h3 class="font-semibold text-gray-800 mb-2">${template.name}</h3>
                        <p class="text-sm text-gray-600 mb-4">Saved on ${new Date(template.created).toLocaleDateString()}</p>
                        <div class="flex gap-2">
                            <button onclick="loadUserTemplate(${template.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Load
                            </button>
                            <button onclick="deleteTemplate(${template.id})" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadTemplate(templateName) {
            const template = builtInTemplates.find(t => t.name === templateName);
            if (template) {
                const textareas = document.querySelectorAll('#planner-content textarea');
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                days.forEach((day, dayIndex) => {
                    meals.forEach((meal, mealIndex) => {
                        const textareaIndex = dayIndex * 3 + mealIndex;
                        const mealKey = Object.keys(template.meals[day])[mealIndex];
                        if (template.meals[day] && template.meals[day][mealKey]) {
                            textareas[textareaIndex].value = template.meals[day][mealKey];
                        }
                    });
                });
                
                switchTab('planner');
                alert('Template loaded successfully!');
            }
        }

        function saveAsTemplate() {
            const name = prompt('Enter a name for this template:');
            if (!name) return;
            
            const textareas = document.querySelectorAll('#planner-content textarea');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const meals = ['Breakfast', 'Lunch', 'Dinner'];
            const templateMeals = {};
            
            days.forEach((day, dayIndex) => {
                templateMeals[day] = {};
                meals.forEach((meal, mealIndex) => {
                    const textareaIndex = dayIndex * 3 + mealIndex;
                    const value = textareas[textareaIndex].value.trim();
                    if (value) {
                        templateMeals[day][meal] = value;
                    }
                });
            });
            
            const template = {
                id: Date.now(),
                name: name,
                meals: templateMeals,
                created: Date.now()
            };
            
            savedTemplates.push(template);
            localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
            alert('Template saved successfully!');
        }

        function loadUserTemplate(id) {
            const template = savedTemplates.find(t => t.id === id);
            if (template) {
                const textareas = document.querySelectorAll('#planner-content textarea');
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                // Clear all textareas first
                textareas.forEach(textarea => textarea.value = '');
                
                days.forEach((day, dayIndex) => {
                    if (template.meals[day]) {
                        Object.entries(template.meals[day]).forEach(([meal, value], mealIndex) => {
                            const textareaIndex = dayIndex * 3 + mealIndex;
                            if (textareas[textareaIndex]) {
                                textareas[textareaIndex].value = value;
                            }
                        });
                    }
                });
                
                switchTab('planner');
                alert('Template loaded successfully!');
            }
        }

        function deleteTemplate(id) {
            if (confirm('Are you sure you want to delete this template?')) {
                savedTemplates = savedTemplates.filter(t => t.id !== id);
                localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
                loadTemplates();
            }
        }

        function generateGroceryList() {
            const textareas = document.querySelectorAll('#planner-content textarea');
            const meals = [];
            
            textareas.forEach(textarea => {
                if (textarea.value.trim()) {
                    meals.push(textarea.value.trim());
                }
            });
            
            if (meals.length === 0) {
                alert('Add some meals to your planner first!');
                return;
            }
            
            // Create a simple grocery list popup
            const groceryWindow = window.open('', 'GroceryList', 'width=600,height=800,scrollbars=yes');
            groceryWindow.document.write(`
                <html>
                <head>
                    <title>Grocery List</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                        .meal { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; }
                        .note { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #ffc107; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>üõí Grocery List</h1>
                    <div class="note">
                        <strong>üìù Note:</strong> This is a basic list based on your meals. Check your pantry, spice drawer, and fridge first!
                    </div>
                    <h2>Planned Meals:</h2>
                    ${meals.map(meal => `<div class="meal">&bull; ${meal}</div>`).join('')}
                    
                    <h2>Shopping Categories:</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <h3>ü•© Proteins</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add proteins needed for your meals</em>
                            </div>
                        </div>
                        <div>
                            <h3>ü•¨ Fresh Produce</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add vegetables and herbs (check your spice drawer first!)</em>
                            </div>
                        </div>
                        <div>
                            <h3>ü•´ Pantry</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add pantry staples</em>
                            </div>
                        </div>
                        <div>
                            <h3>‚ùÑÔ∏è Frozen</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add frozen items (maybe backup Dinner Ladies meals?)</em>
                            </div>
                        </div>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px;">
                        <button onclick="window.print()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üñ®Ô∏è Print List</button>
                        <button onclick="window.close()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
        }

        function saveMealPlan() {
            const textareas = document.querySelectorAll('#planner-content textarea');
            const mealPlan = {};
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const meals = ['Breakfast', 'Lunch', 'Dinner'];
            
            days.forEach((day, dayIndex) => {
                mealPlan[day] = {};
                meals.forEach((meal, mealIndex) => {
                    const textareaIndex = dayIndex * 3 + mealIndex;
                    mealPlan[day][meal] = textareas[textareaIndex].value;
                });
            });
            
            localStorage.setItem('mealPlan', JSON.stringify(mealPlan));
            alert('Meal plan saved!');
        }

        function clearMealPlan() {
            if (confirm('Are you sure you want to clear all meals?')) {
                document.querySelectorAll('#planner-content textarea').forEach(textarea => {
                    textarea.value = '';
                });
                localStorage.removeItem('mealPlan');
            }
        }

        function loadMealPlan() {
            const savedPlan = localStorage.getItem('mealPlan');
            if (savedPlan) {
                const mealPlan = JSON.parse(savedPlan);
                const textareas = document.querySelectorAll('#planner-content textarea');
                
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                days.forEach((day, dayIndex) => {
                    if (mealPlan[day]) {
                        meals.forEach((meal, mealIndex) => {
                            const textareaIndex = dayIndex * 3 + mealIndex;
                            if (mealPlan[day][meal]) {
                                textareas[textareaIndex].value = mealPlan[day][meal];
                            }
                        });
                    }
                });
            }
        }

        // Load saved meal plan when page loads
        window.addEventListener('load', loadMealPlan);
        
        // Auto-suggest energy level based on time and day (based on your schedule)
        window.addEventListener('load', function() {
            const now = new Date();
            const day = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const hour = now.getHours();
            
            // Auto-suggest energy level based on your schedule
            let suggestedEnergy = 'medium';
            
            // Tuesday (WFH day) - suggest high energy
            if (day === 2) {
                suggestedEnergy = 'high';
            }
            // Friday evening (before bar work) or very late/early hours
            else if ((day === 5 && hour >= 17) || hour < 6 || hour > 23) {
                suggestedEnergy = 'low';
            }
            // Weekend mornings (after bar work)
            else if ((day === 6 || day === 0) && hour < 12) {
                suggestedEnergy = 'low';
            }
            
            // Highlight the suggested energy level
            const suggestedBtn = document.getElementById(`energy-${suggestedEnergy}`);
            if (suggestedBtn) {
                suggestedBtn.style.boxShadow = '0 0 0 2px #3b82f6';
                suggestedBtn.style.animation = 'pulse 2s infinite';
            }
        });

        // ===== Authentication Functions =====
        
        function showAuthModal(defaultTab = 'login') {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                modal.classList.remove('hidden');
                showAuthTab(defaultTab);
            }
        }

        function hideAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            if (tab === 'login') {
                loginTab.classList.add('bg-blue-500', 'text-white');
                loginTab.classList.remove('text-gray-700', 'hover:bg-gray-100');
                signupTab.classList.remove('bg-blue-500', 'text-white');
                signupTab.classList.add('text-gray-700', 'hover:bg-gray-100');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                signupTab.classList.add('bg-blue-500', 'text-white');
                signupTab.classList.remove('text-gray-700', 'hover:bg-gray-100');
                loginTab.classList.remove('bg-blue-500', 'text-white');
                loginTab.classList.add('text-gray-700', 'hover:bg-gray-100');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        async function signInWithProvider(provider) {
            try {
                const result = await window.mealPlannerAPI.signInWithProvider(provider);
                console.log('OAuth sign in initiated:', result);
                hideAuthModal();
            } catch (error) {
                console.error('OAuth sign in failed:', error);
                alert('Sign in failed. Please check your internet connection and try again.');
            }
        }

        async function handleEmailSignIn(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const result = await window.mealPlannerAPI.signIn(email, password);
                console.log('Email sign in successful:', result);
                hideAuthModal();
            } catch (error) {
                console.error('Email sign in failed:', error);
                alert('Sign in failed: ' + error.message);
            }
        }

        async function handleEmailSignUp(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const displayName = document.getElementById('signup-name').value;

            try {
                const result = await window.mealPlannerAPI.signUp(email, password, {
                    display_name: displayName
                });
                console.log('Email sign up successful:', result);
                hideAuthModal();
                alert('Account created! Please check your email to verify your account.');
            } catch (error) {
                console.error('Email sign up failed:', error);
                alert('Sign up failed: ' + error.message);
            }
        }

        function showUserMenu() {
            const userMenu = document.getElementById('user-menu');
            const user = window.mealPlannerAPI.getCurrentUser();
            
            if (user && userMenu) {
                // Update menu with current user info
                document.getElementById('menu-user-name').textContent = user.user_metadata?.display_name || user.email;
                document.getElementById('menu-user-email').textContent = user.email;
                
                // Toggle menu visibility
                userMenu.classList.toggle('hidden');
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!userMenu.contains(e.target) && !e.target.closest('#user-info')) {
                            userMenu.classList.add('hidden');
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }
        }

        function showProfileModal() {
            const modal = document.getElementById('profile-modal');
            const user = window.mealPlannerAPI.getCurrentUser();
            
            if (user && modal) {
                loadUserProfile(user);
                modal.classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
            }
        }

        function hideProfileModal() {
            const modal = document.getElementById('profile-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function loadUserProfile(user) {
            try {
                // Load user profile data
                const profile = await window.mealPlannerAPI.getUserProfile() || {};
                
                // Basic user info
                document.getElementById('profile-name').textContent = user.user_metadata?.display_name || user.email;
                document.getElementById('profile-email').textContent = user.email;
                
                // Avatar
                const avatar = document.getElementById('profile-avatar');
                const placeholder = document.getElementById('profile-avatar-placeholder');
                if (user.user_metadata?.avatar_url) {
                    avatar.src = user.user_metadata.avatar_url;
                    avatar.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                } else {
                    avatar.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                    placeholder.textContent = (user.user_metadata?.display_name || user.email).charAt(0).toUpperCase();
                }
                
                // Provider info
                const provider = user.app_metadata?.provider || 'email';
                document.getElementById('profile-provider').textContent = `Signed in via ${provider}`;
                
                // Form fields
                document.getElementById('profile-display-name').value = user.user_metadata?.display_name || '';
                document.getElementById('profile-avatar-url').value = profile.avatar_url || '';
                
                // Equipment checkboxes
                const equipment = profile.cooking_equipment || [];
                document.querySelectorAll('.equipment-checkbox').forEach(cb => {
                    cb.checked = equipment.includes(cb.value);
                });
                
                // Dietary restrictions
                const dietary = profile.dietary_restrictions || [];
                document.querySelectorAll('.dietary-checkbox').forEach(cb => {
                    cb.checked = dietary.includes(cb.value);
                });
                
                // Show/hide sections based on provider
                const passwordSection = document.getElementById('password-section');
                const oauthSection = document.getElementById('oauth-section');
                
                if (provider === 'email') {
                    passwordSection.classList.remove('hidden');
                    oauthSection.classList.add('hidden');
                } else {
                    passwordSection.classList.add('hidden');
                    oauthSection.classList.remove('hidden');
                    
                    // OAuth provider info
                    const providerIcon = document.getElementById('oauth-provider-icon');
                    const providerText = document.getElementById('oauth-provider-text');
                    
                    if (provider === 'google') {
                        providerIcon.innerHTML = 'üîç';
                        providerText.textContent = 'Google Account';
                    } else if (provider === 'github') {
                        providerIcon.innerHTML = 'üêô';
                        providerText.textContent = 'GitHub Account';
                    }
                }
                
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            
            const successDiv = document.getElementById('profile-success');
            const errorDiv = document.getElementById('profile-error');
            const errorMessage = document.getElementById('profile-error-message');
            
            // Reset messages
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            
            try {
                // Collect equipment
                const equipment = Array.from(document.querySelectorAll('.equipment-checkbox:checked'))
                    .map(cb => cb.value);
                
                // Collect dietary restrictions
                const dietary = Array.from(document.querySelectorAll('.dietary-checkbox:checked'))
                    .map(cb => cb.value);
                
                // Prepare profile data
                const profileData = {
                    display_name: document.getElementById('profile-display-name').value,
                    avatar_url: document.getElementById('profile-avatar-url').value,
                    cooking_equipment: equipment,
                    dietary_restrictions: dietary
                };
                
                // Save to Supabase
                await window.mealPlannerAPI.updateUserProfile(profileData);
                
                // Show success message
                successDiv.classList.remove('hidden');
                
                // Update UI
                updateAuthUI(window.mealPlannerAPI.getCurrentUser());
                
            } catch (error) {
                console.error('Error saving profile:', error);
                errorMessage.textContent = error.message || 'Failed to save profile';
                errorDiv.classList.remove('hidden');
            }
        }

        async function changePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('profile-error');
            const errorMessage = document.getElementById('profile-error-message');
            const successDiv = document.getElementById('profile-success');
            
            if (!newPassword || newPassword.length < 6) {
                errorMessage.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Note: Supabase doesn't have updatePassword - user needs to reset via email
                errorMessage.textContent = 'Password changes require email verification. Please use "Forgot Password" in the login form.';
                errorDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error changing password:', error);
                errorMessage.textContent = error.message || 'Failed to change password';
                errorDiv.classList.remove('hidden');
            }
        }

        function exportData() {
            // Close menu
            document.getElementById('user-menu').classList.add('hidden');
            
            // Export user data
            const data = {
                recipes: JSON.parse(localStorage.getItem('recipes')) || [],
                mealPlan: JSON.parse(localStorage.getItem('mealPlan')) || {},
                templates: JSON.parse(localStorage.getItem('savedTemplates')) || []
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meal-planner-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            // Close menu
            document.getElementById('user-menu').classList.add('hidden');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (data.recipes) localStorage.setItem('recipes', JSON.stringify(data.recipes));
                            if (data.mealPlan) localStorage.setItem('mealPlan', JSON.stringify(data.mealPlan));
                            if (data.templates) localStorage.setItem('savedTemplates', JSON.stringify(data.templates));
                            
                            alert('Data imported successfully! Please refresh the page.');
                        } catch (error) {
                            alert('Invalid file format. Please select a valid JSON export file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        async function signOut() {
            try {
                await window.mealPlannerAPI.signOut();
                console.log('Signed out successfully');
            } catch (error) {
                console.error('Sign out failed:', error);
            }
        }

        async function migrateLocalData() {
            try {
                await window.mealPlannerAPI.migrateLocalStorageToSupabase();
                alert('Local data migrated successfully! Your recipes and meal plans are now saved to your account.');
                location.reload(); // Refresh to load cloud data
            } catch (error) {
                console.error('Migration failed:', error);
                alert('Migration failed: ' + error.message);
            }
        }

        // Note: Primary auth state change handler is defined at the bottom to handle onboarding

        function updateAuthUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const userAvatar = document.getElementById('user-avatar');

            if (user) {
                // User is signed in
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                
                userName.textContent = user.user_metadata?.display_name || user.email;
                
                if (user.user_metadata?.avatar_url) {
                    userAvatar.src = user.user_metadata.avatar_url;
                    userAvatar.classList.remove('hidden');
                } else {
                    userAvatar.classList.add('hidden');
                }
            } else {
                // User is signed out
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
            }
        }

        function showForgotPassword() {
            const email = prompt('Enter your email address for password reset:');
            if (email) {
                window.mealPlannerAPI.resetPassword(email)
                    .then(() => {
                        alert('Password reset email sent! Please check your inbox.');
                    })
                    .catch((error) => {
                        console.error('Password reset failed:', error);
                        alert('Password reset failed: ' + error.message);
                    });
            }
        }

        // Bug report functions (ensure they're available globally)
        function showBugReportModal() {
            if (window.bugReportSystem) {
                window.bugReportSystem.showBugReportModal();
            } else {
                console.error('Bug report system not loaded');
                alert('Bug reporting system is loading. Please try again in a moment.');
            }
        }

        function closeBugReportModal() {
            if (window.bugReportSystem) {
                window.bugReportSystem.closeBugReportModal();
            }
        }

        // Make functions globally available
        window.showBugReportModal = showBugReportModal;
        window.closeBugReportModal = closeBugReportModal;

        // Recipe Import Functions
        let importedRecipeData = null;

        function showImportTab(tab) {
            const manualTab = document.getElementById('manual-tab');
            const urlTab = document.getElementById('url-tab');
            const urlSection = document.getElementById('url-import-section');
            const manualForm = document.getElementById('recipe-form');

            if (tab === 'url') {
                // Switch to URL import
                urlTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                urlTab.classList.remove('text-gray-500', 'hover:text-gray-700');
                manualTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                manualTab.classList.add('text-gray-500', 'hover:text-gray-700');
                
                urlSection.classList.remove('hidden');
                manualForm.classList.add('hidden');
            } else {
                // Switch to manual entry
                manualTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                manualTab.classList.remove('text-gray-500', 'hover:text-gray-700');
                urlTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                urlTab.classList.add('text-gray-500', 'hover:text-gray-700');
                
                urlSection.classList.add('hidden');
                manualForm.classList.remove('hidden');
            }
        }

        async function importRecipeFromUrl() {
            const url = document.getElementById('import-url').value;
            const statusDiv = document.getElementById('import-status');
            const messageDiv = document.getElementById('import-message');
            const previewDiv = document.getElementById('import-preview');

            if (!url) {
                showImportStatus('Please enter a recipe URL', 'error');
                return;
            }

            // Validate URL
            if (!isValidRecipeUrl(url)) {
                showImportStatus('Please enter a valid recipe URL from a supported site', 'error');
                return;
            }

            showImportStatus('Extracting recipe data...', 'loading');

            try {
                const recipeData = await extractRecipeFromUrl(url);
                if (recipeData) {
                    importedRecipeData = recipeData;
                    showRecipePreview(recipeData);
                    showImportStatus('Recipe extracted successfully!', 'success');
                    previewDiv.classList.remove('hidden');
                } else {
                    showImportStatus('Could not extract recipe data from this URL', 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showImportStatus('Failed to import recipe: ' + error.message, 'error');
            }
        }

        function isValidRecipeUrl(url) {
            const supportedDomains = [
                'recipetineats.com',
                'www.recipetineats.com'
            ];
            
            try {
                const urlObj = new URL(url);
                return supportedDomains.some(domain => urlObj.hostname === domain);
            } catch {
                return false;
            }
        }

        async function extractRecipeFromUrl(url) {
            // Since we can't directly fetch from other domains due to CORS,
            // we'll use a CORS proxy service for demonstration
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            
            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const htmlContent = data.contents;
                
                // Parse the HTML to extract JSON-LD recipe data
                return parseRecipeFromHtml(htmlContent);
            } catch (error) {
                console.error('Fetch error:', error);
                throw new Error('Unable to fetch recipe data');
            }
        }

        function parseRecipeFromHtml(html) {
            // Create a temporary DOM element to parse the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Look for JSON-LD script tags
            const jsonLdScripts = doc.querySelectorAll('script[type="application/ld+json"]');
            
            for (const script of jsonLdScripts) {
                try {
                    const data = JSON.parse(script.textContent);
                    
                    // Handle different JSON-LD structures
                    let recipe = null;
                    
                    if (data['@type'] === 'Recipe') {
                        recipe = data;
                    } else if (data['@graph']) {
                        recipe = data['@graph'].find(item => item['@type'] === 'Recipe');
                    } else if (Array.isArray(data)) {
                        recipe = data.find(item => item['@type'] === 'Recipe');
                    }
                    
                    if (recipe) {
                        return formatRecipeData(recipe);
                    }
                } catch (e) {
                    console.log('Failed to parse JSON-LD script:', e);
                }
            }
            
            return null;
        }

        function formatRecipeData(recipeJson) {
            const recipe = {
                title: recipeJson.name || '',
                description: recipeJson.description || '',
                ingredients: [],
                instructions: recipeJson.recipeInstructions || [],
                cookingTime: extractTime(recipeJson.cookTime) || extractTime(recipeJson.totalTime) || 30,
                energyLevel: 'medium',
                equipment: extractEquipment(recipeJson),
                icon: 'üçΩÔ∏è',
                servings: recipeJson.recipeYield || '',
                prepTime: extractTime(recipeJson.prepTime) || '',
                source: recipeJson.url || ''
            };

            // Format ingredients
            if (recipeJson.recipeIngredient) {
                recipe.ingredients = recipeJson.recipeIngredient.map(ingredient => 
                    typeof ingredient === 'string' ? ingredient : ingredient.name || ingredient
                );
            }

            // Format instructions
            if (recipeJson.recipeInstructions) {
                recipe.instructions = formatInstructions(recipeJson.recipeInstructions);
            }

            return recipe;
        }

        function extractTime(timeStr) {
            if (!timeStr) return null;
            
            // Handle ISO 8601 duration format (PT15M = 15 minutes)
            const isoMatch = timeStr.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
            if (isoMatch) {
                const hours = parseInt(isoMatch[1] || 0);
                const minutes = parseInt(isoMatch[2] || 0);
                return hours * 60 + minutes;
            }
            
            // Handle simple number
            const numMatch = timeStr.match(/(\d+)/);
            if (numMatch) {
                return parseInt(numMatch[1]);
            }
            
            return null;
        }

        function extractEquipment(recipeJson) {
            const equipment = [];
            const text = (recipeJson.description || '') + ' ' + JSON.stringify(recipeJson.recipeInstructions || []);
            
            const equipmentKeywords = {
                'Instant Pot': ['instant pot', 'pressure cooker'],
                'Cast Iron': ['cast iron', 'skillet'],
                'Stand Mixer': ['stand mixer', 'kitchenaid'],
                'Air Fryer': ['air fryer'],
                'Sous Vide': ['sous vide'],
                'Pizza Oven': ['pizza oven']
            };
            
            for (const [equipment_name, keywords] of Object.entries(equipmentKeywords)) {
                if (keywords.some(keyword => text.toLowerCase().includes(keyword))) {
                    equipment.push(equipment_name);
                }
            }
            
            return equipment;
        }

        function formatInstructions(instructions) {
            if (typeof instructions === 'string') {
                return instructions;
            }
            
            if (Array.isArray(instructions)) {
                return instructions.map(instruction => {
                    if (typeof instruction === 'string') {
                        return instruction;
                    } else if (instruction.text) {
                        return instruction.text;
                    } else if (instruction['@type'] === 'HowToStep') {
                        return instruction.text || instruction.name || '';
                    } else if (instruction['@type'] === 'HowToSection') {
                        const sectionSteps = instruction.itemListElement || [];
                        return sectionSteps.map(step => step.text || step.name || '').join(' ');
                    }
                    return JSON.stringify(instruction);
                }).filter(Boolean).join('\n\n');
            }
            
            return '';
        }

        function showImportStatus(message, type) {
            const statusDiv = document.getElementById('import-status');
            const messageDiv = document.getElementById('import-message');
            
            statusDiv.classList.remove('hidden');
            messageDiv.textContent = message;
            
            // Reset classes
            statusDiv.classList.remove('bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200', 'bg-blue-50', 'border-blue-200');
            messageDiv.classList.remove('text-red-800', 'text-green-800', 'text-blue-800');
            
            if (type === 'error') {
                statusDiv.classList.add('bg-red-50', 'border-red-200');
                messageDiv.classList.add('text-red-800');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-50', 'border-green-200');
                messageDiv.classList.add('text-green-800');
            } else {
                statusDiv.classList.add('bg-blue-50', 'border-blue-200');
                messageDiv.classList.add('text-blue-800');
            }
        }

        function showRecipePreview(recipe) {
            const previewContent = document.getElementById('preview-content');
            
            previewContent.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <h5 class="font-medium text-gray-800">${recipe.title}</h5>
                        <p class="text-sm text-gray-600">${recipe.description}</p>
                    </div>
                    
                    ${recipe.servings ? `<div class="text-sm"><strong>Serves:</strong> ${recipe.servings}</div>` : ''}
                    ${recipe.prepTime ? `<div class="text-sm"><strong>Prep:</strong> ${recipe.prepTime} minutes</div>` : ''}
                    ${recipe.cookingTime ? `<div class="text-sm"><strong>Cook:</strong> ${recipe.cookingTime} minutes</div>` : ''}
                    
                    <div>
                        <strong class="text-sm">Ingredients (${recipe.ingredients.length}):</strong>
                        <div class="text-sm text-gray-600 max-h-24 overflow-y-auto">
                            ${recipe.ingredients.slice(0, 5).map(ing => `‚Ä¢ ${ing}`).join('<br>')}
                            ${recipe.ingredients.length > 5 ? `<br>... and ${recipe.ingredients.length - 5} more` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <strong class="text-sm">Instructions:</strong>
                        <div class="text-sm text-gray-600 max-h-24 overflow-y-auto">
                            ${recipe.instructions.substring(0, 200)}...
                        </div>
                    </div>
                </div>
            `;
        }

        function saveImportedRecipe() {
            if (importedRecipeData) {
                addRecipe(importedRecipeData);
                hideAddRecipeModal();
                showImportStatus('Recipe saved successfully!', 'success');
            }
        }

        function editImportedRecipe() {
            if (importedRecipeData) {
                // Switch to manual tab and populate fields
                showImportTab('manual');
                
                // Fill the manual form with imported data
                document.getElementById('recipe-name').value = importedRecipeData.title;
                document.getElementById('recipe-description').value = importedRecipeData.description;
                document.getElementById('recipe-ingredients').value = importedRecipeData.ingredients.join('\n');
                document.getElementById('recipe-instructions').value = importedRecipeData.instructions;
                document.getElementById('recipe-time').value = importedRecipeData.cookingTime;
                document.getElementById('recipe-energy').value = importedRecipeData.energyLevel;
                
                // Check equipment boxes
                importedRecipeData.equipment.forEach(eq => {
                    const checkbox = document.querySelector(`input[value="${eq}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Recipe Browser Functions
        let currentCategory = null;
        let recipeResults = [];
        let displayedRecipes = 0;
        const recipesPerPage = 12;

        async function browseCategory(category) {
            currentCategory = category;
            displayedRecipes = 0;
            recipeResults = [];
            
            showBrowseStatus(`Loading ${category} recipes...`, 'loading');
            
            try {
                // Simulate category browsing by fetching category page
                const categoryUrl = `https://www.recipetineats.com/category/${category}/`;
                const recipes = await fetchCategoryRecipes(categoryUrl);
                
                recipeResults = recipes;
                displayRecipeResults(recipes.slice(0, recipesPerPage));
                displayedRecipes = Math.min(recipesPerPage, recipes.length);
                
                showBrowseStatus(`Found ${recipes.length} ${category} recipes`, 'success');
                
                // Show load more button if there are more recipes
                const loadMoreContainer = document.getElementById('load-more-container');
                if (recipes.length > recipesPerPage) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Browse error:', error);
                showBrowseStatus(`Failed to load ${category} recipes: ${error.message}`, 'error');
            }
        }

        async function searchRecipes() {
            const searchTerm = document.getElementById('browse-recipe-search').value.trim();
            if (!searchTerm) {
                showBrowseStatus('Please enter a search term', 'error');
                return;
            }
            
            showBrowseStatus(`Searching for "${searchTerm}"...`, 'loading');
            
            try {
                // For demonstration, we'll search within a general category
                const searchUrl = `https://www.recipetineats.com/?s=${encodeURIComponent(searchTerm)}`;
                const recipes = await fetchSearchResults(searchUrl, searchTerm);
                
                recipeResults = recipes;
                displayRecipeResults(recipes.slice(0, recipesPerPage));
                displayedRecipes = Math.min(recipesPerPage, recipes.length);
                
                showBrowseStatus(`Found ${recipes.length} recipes for "${searchTerm}"`, 'success');
                
                const loadMoreContainer = document.getElementById('load-more-container');
                if (recipes.length > recipesPerPage) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Search error:', error);
                showBrowseStatus(`Search failed: ${error.message}`, 'error');
            }
        }

        async function fetchCategoryRecipes(categoryUrl) {
            // Use CORS proxy to fetch category page
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(categoryUrl)}`;
            
            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();
                return parseRecipeListFromHtml(data.contents);
            } catch (error) {
                throw new Error('Unable to fetch category recipes');
            }
        }

        async function fetchSearchResults(searchUrl, searchTerm) {
            // For demo purposes, return some mock recipes for common searches
            const mockRecipes = {
                'chicken': [
                    { title: 'Chicken Stir Fry', url: 'https://www.recipetineats.com/chicken-stir-fry/', description: 'Quick and easy chicken stir fry with vegetables' },
                    { title: 'Honey Garlic Chicken', url: 'https://www.recipetineats.com/honey-garlic-chicken/', description: 'Sweet and savory glazed chicken' },
                    { title: 'Chicken Curry', url: 'https://www.recipetineats.com/chicken-curry/', description: 'Creamy and aromatic chicken curry' },
                ],
                'beef': [
                    { title: 'Beef Stroganoff', url: 'https://www.recipetineats.com/beef-stroganoff/', description: 'Classic creamy beef stroganoff' },
                    { title: 'Beef and Broccoli', url: 'https://www.recipetineats.com/beef-broccoli/', description: 'Chinese-style beef and broccoli' },
                ],
                'pasta': [
                    { title: 'Spaghetti Carbonara', url: 'https://www.recipetineats.com/carbonara/', description: 'Authentic Italian carbonara' },
                    { title: 'Beef Ragu', url: 'https://www.recipetineats.com/beef-ragu/', description: 'Rich and hearty beef ragu sauce' },
                ]
            };

            // Find matching recipes
            for (const [category, recipes] of Object.entries(mockRecipes)) {
                if (searchTerm.toLowerCase().includes(category)) {
                    return recipes;
                }
            }

            // Return a few general recipes if no specific match
            return [
                { title: 'Classic Chicken Stir Fry', url: 'https://www.recipetineats.com/chicken-stir-fry/', description: 'A versatile and quick dinner option' }
            ];
        }

        function parseRecipeListFromHtml(html) {
            // This would normally parse the HTML to extract recipe links and titles
            // For demo purposes, return some sample recipes based on common categories
            const sampleRecipes = {
                'asian': [
                    { title: 'Chicken Stir Fry', url: 'https://www.recipetineats.com/chicken-stir-fry/', description: 'Quick and flavorful Asian-style stir fry' },
                    { title: 'Beef and Broccoli', url: 'https://www.recipetineats.com/beef-broccoli/', description: 'Classic Chinese takeout favorite' },
                    { title: 'Fried Rice', url: 'https://www.recipetineats.com/fried-rice/', description: 'Perfect for using leftover rice' },
                    { title: 'Thai Basil Chicken', url: 'https://www.recipetineats.com/thai-basil-chicken/', description: 'Aromatic Thai stir fry' },
                ],
                'italian': [
                    { title: 'Spaghetti Carbonara', url: 'https://www.recipetineats.com/carbonara/', description: 'Authentic Roman pasta dish' },
                    { title: 'Chicken Parmigiana', url: 'https://www.recipetineats.com/chicken-parmigiana/', description: 'Crispy breaded chicken with marinara' },
                    { title: 'Beef Ragu', url: 'https://www.recipetineats.com/beef-ragu/', description: 'Rich, slow-cooked meat sauce' },
                ],
                'mexican': [
                    { title: 'Chicken Tacos', url: 'https://www.recipetineats.com/chicken-tacos/', description: 'Juicy seasoned chicken in soft tortillas' },
                    { title: 'Beef Enchiladas', url: 'https://www.recipetineats.com/beef-enchiladas/', description: 'Cheesy rolled tortillas in red sauce' },
                ],
                'indian': [
                    { title: 'Chicken Curry', url: 'https://www.recipetineats.com/chicken-curry/', description: 'Creamy and aromatic chicken curry' },
                    { title: 'Butter Chicken', url: 'https://www.recipetineats.com/butter-chicken/', description: 'Rich tomato-based curry' },
                ]
            };

            return sampleRecipes[currentCategory] || sampleRecipes['asian'] || [];
        }

        function displayRecipeResults(recipes) {
            const resultsContainer = document.getElementById('recipe-results');
            
            if (recipes.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-8">
                        <p class="text-lg">No recipes found</p>
                        <p class="text-sm">Try a different category or search term</p>
                    </div>
                `;
                return;
            }

            resultsContainer.innerHTML = recipes.map(recipe => `
                <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow">
                    <h4 class="font-semibold text-gray-800 mb-2">${recipe.title}</h4>
                    <p class="text-sm text-gray-600 mb-3">${recipe.description}</p>
                    <div class="flex gap-2">
                        <button onclick="importSpecificRecipe('${recipe.url}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs py-2 px-3 rounded transition-colors">
                            üì• Import Recipe
                        </button>
                        <a href="${recipe.url}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white text-xs py-2 px-3 rounded transition-colors">
                            üëÄ View
                        </a>
                    </div>
                </div>
            `).join('');
        }

        function loadMoreRecipes() {
            const nextBatch = recipeResults.slice(displayedRecipes, displayedRecipes + recipesPerPage);
            
            if (nextBatch.length > 0) {
                const resultsContainer = document.getElementById('recipe-results');
                
                nextBatch.forEach(recipe => {
                    const recipeElement = document.createElement('div');
                    recipeElement.className = 'bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow';
                    recipeElement.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-2">${recipe.title}</h4>
                        <p class="text-sm text-gray-600 mb-3">${recipe.description}</p>
                        <div class="flex gap-2">
                            <button onclick="importSpecificRecipe('${recipe.url}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs py-2 px-3 rounded transition-colors">
                                üì• Import Recipe
                            </button>
                            <a href="${recipe.url}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white text-xs py-2 px-3 rounded transition-colors">
                                üëÄ View
                            </a>
                        </div>
                    `;
                    resultsContainer.appendChild(recipeElement);
                });
                
                displayedRecipes += nextBatch.length;
                
                // Hide load more button if we've shown all recipes
                if (displayedRecipes >= recipeResults.length) {
                    document.getElementById('load-more-container').classList.add('hidden');
                }
            }
        }

        async function importSpecificRecipe(recipeUrl) {
            showBrowseStatus('Importing recipe...', 'loading');
            
            try {
                const recipeData = await extractRecipeFromUrl(recipeUrl);
                if (recipeData) {
                    addRecipe(recipeData);
                    showBrowseStatus('Recipe imported successfully! Check your "My Recipes" tab.', 'success');
                } else {
                    showBrowseStatus('Could not extract recipe data from this URL', 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showBrowseStatus('Failed to import recipe: ' + error.message, 'error');
            }
        }

        function showBrowseStatus(message, type) {
            const statusDiv = document.getElementById('browse-status');
            const messageDiv = document.getElementById('browse-message');
            
            statusDiv.classList.remove('hidden');
            messageDiv.textContent = message;
            
            // Reset classes
            statusDiv.classList.remove('bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200', 'bg-blue-50', 'border-blue-200');
            messageDiv.classList.remove('text-red-800', 'text-green-800', 'text-blue-800');
            
            if (type === 'error') {
                statusDiv.classList.add('bg-red-50', 'border-red-200');
                messageDiv.classList.add('text-red-800');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-50', 'border-green-200');
                messageDiv.classList.add('text-green-800');
            } else {
                statusDiv.classList.add('bg-blue-50', 'border-blue-200');
                messageDiv.classList.add('text-blue-800');
            }
        }

        // Authentication gates and onboarding
        let isUserAuthenticated = false;
        
        function checkAuthenticationRequired() {
            console.log('üîê Checking authentication...');
            const user = window.mealPlannerAPI ? window.mealPlannerAPI.getCurrentUser() : null;
            isUserAuthenticated = !!user;
            
            console.log('üë§ User:', user ? user.email : 'Not logged in');
            
            if (!isUserAuthenticated) {
                console.log('üö™ No user found, showing auth gate...');
                // Show auth gate overlay
                showAuthGate();
                return false;
            } else {
                console.log('‚úÖ User authenticated, checking onboarding...');
                // Check if user needs onboarding
                checkOnboardingStatus(user);
                return true;
            }
        }

        function showAuthGate() {
            console.log('üö™ Showing auth gate...');
            
            // Hide main app
            const mainApp = document.getElementById('main-app');
            if (mainApp) {
                mainApp.classList.add('hidden');
                console.log('üì± Main app hidden');
            }
            
            // Show auth gate (it's visible by default now, but ensure it's shown)
            const authGate = document.getElementById('auth-gate');
            if (authGate) {
                authGate.classList.remove('hidden');
                console.log('üö™ Auth gate shown');
            } else {
                console.error('‚ùå Auth gate element not found!');
            }
        }

        function hideAuthGate() {
            const authGate = document.getElementById('auth-gate');
            const mainApp = document.getElementById('main-app');
            if (authGate) {
                authGate.classList.add('hidden');
            }
            if (mainApp) {
                mainApp.classList.remove('hidden');
            }
        }

        async function checkOnboardingStatus(user) {
            try {
                // If onboarding was just completed in this session, skip check
                if (onboardingCompleted) {
                    console.log('üéØ Onboarding completed in this session, showing app...');
                    hideAuthGate();
                    switchTab('planner');
                    return;
                }
                
                console.log('üîç Checking user profile for onboarding status...');
                
                const profile = await window.mealPlannerAPI.getUserProfile();
                console.log('üìä User profile:', profile);
                
                // Check if user needs onboarding (no profile or incomplete profile)
                if (!profile || !profile.onboarding_completed) {
                    console.log('‚ùå Onboarding needed - profile missing or incomplete');
                    showOnboardingFlow(user);
                } else {
                    console.log('‚úÖ Onboarding complete - showing app');
                    // User is fully set up, show normal app
                    hideAuthGate();
                    switchTab('planner');
                }
            } catch (error) {
                console.error('Error checking onboarding status:', error);
                // Assume onboarding needed if we can't check
                showOnboardingFlow(user);
            }
        }

        function showOnboardingFlow(user) {
            hideAuthGate();
            const onboardingModal = document.getElementById('onboarding-modal');
            if (onboardingModal) {
                onboardingModal.classList.remove('hidden');
                startAIOnboarding(user);
            }
        }

        // Override tab switching to require auth
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            // Skip auth check if user is already authenticated to prevent infinite loop
            const user = window.mealPlannerAPI ? window.mealPlannerAPI.getCurrentUser() : null;
            if (!user) {
                checkAuthenticationRequired();
                return;
            }
            originalSwitchTab(tabName);
        };

        // Override other functions to require auth
        function requireAuth(originalFunction) {
            return function(...args) {
                if (!checkAuthenticationRequired()) {
                    return;
                }
                return originalFunction.apply(this, args);
            };
        }

        // Wrap functions that need auth
        const originalShowAddRecipeModal = showAddRecipeModal;
        showAddRecipeModal = requireAuth(originalShowAddRecipeModal);

        const originalBrowseCategory = browseCategory;
        browseCategory = requireAuth(originalBrowseCategory);

        const originalSearchRecipes = searchRecipes;
        searchRecipes = requireAuth(originalSearchRecipes);

        // AI Onboarding System
        let onboardingConversation = [];
        let onboardingStep = 0;
        let userOnboardingData = {};
        let onboardingCompleted = sessionStorage.getItem('onboardingCompleted') === 'true'; // Flag to prevent restart loops

        async function startAIOnboarding(user) {
            onboardingConversation = [];
            onboardingStep = 0;
            userOnboardingData = {
                name: user.user_metadata?.display_name || user.email.split('@')[0] || 'there',
                responses: []
            };
            
            // Clear chat
            document.getElementById('onboarding-chat').innerHTML = '';
            updateOnboardingProgress(1, 11);
            
            const welcomeMessage = `Hi ${userOnboardingData.name}! üëã 

I'm your AI cooking assistant, and I'm here to learn about your unique life situation so I can suggest meal plans and recipes that actually work for YOU.

Instead of boring multiple choice questions, let's have a real conversation. I'll ask you about your lifestyle, cooking experience, kitchen setup, dietary needs, and any challenges you face - just like if we were chatting over coffee.

**First, let's make sure I'm calling you the right name, then tell me about your life stage and living situation.**`;
            
            addOnboardingMessage('ai', welcomeMessage);
            showDisplayNameAndLifeStage();
        }

        function addOnboardingMessage(sender, message) {
            const chatContainer = document.getElementById('onboarding-chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-6 ${sender === 'ai' ? 'text-left' : 'text-right'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `inline-block p-4 rounded-xl max-w-2xl text-base leading-relaxed ${
                sender === 'ai' 
                ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-gray-800 border border-blue-200' 
                : 'bg-gradient-to-r from-green-50 to-emerald-50 text-gray-800 border border-green-200'
            }`;
            
            // Support markdown-style bold text
            messageBubble.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
            
            messageDiv.appendChild(messageBubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateOnboardingProgress(current, total) {
            const progressElement = document.getElementById('onboarding-progress');
            if (progressElement) {
                progressElement.textContent = `Step ${current} of ${total}`;
            }
        }


        async function useTestData() {
            if (confirm('Use test data to quickly complete onboarding? This will skip the conversation and set up a sample profile.')) {
                const user = window.mealPlannerAPI.getCurrentUser();
                
                // Sample test data profile
                const testProfileData = {
                    display_name: 'Test User',
                    onboarding_type: 'conversational',
                    age_range: 'Mid-30s, single professional',
                    living_situation: 'Studio apartment, lives alone',
                    accessibility_needs: 'ADHD - needs simple, quick meal options',
                    cooking_background: 'Beginner level, comfortable with basics',
                    dietary_needs: 'No major restrictions, trying to eat healthier',
                    kitchen_equipment: 'Basic setup: stovetop, oven, microwave, blender',
                    schedule_energy: 'Irregular work schedule, medium energy most days',
                    goals_challenges: 'Want to meal prep on weekends, avoid takeout during busy weeks',
                    skills_comfort: 'Comfortable with simple recipes, want to learn new techniques',
                    flavor_preferences: 'Italian, Asian, comfort foods, not too spicy',
                    planning_style: 'Batch cook on weekends, quick assembly during week',
                    onboarding_completed: true,
                    onboarding_date: new Date().toISOString(),
                    profile_version: '5.0'
                };
                
                try {
                    await window.mealPlannerAPI.updateUserProfile(testProfileData);
                    console.log('‚úÖ Test profile saved successfully');
                    
                    // Set completion flag and persist it
                    onboardingCompleted = true;
                    sessionStorage.setItem('onboardingCompleted', 'true');
                    
                    // Update auth UI to show user info
                    updateAuthUI(user);
                    
                    // Hide onboarding modal and show success
                    document.getElementById('onboarding-modal').classList.add('hidden');
                    showOnboardingComplete();
                    
                    setTimeout(() => {
                        hideAuthGate();
                        switchTab('planner');
                    }, 2000);
                    
                } catch (error) {
                    console.error('‚ùå Error saving test profile:', error);
                    
                    // Fallback to localStorage
                    localStorage.setItem('userProfile', JSON.stringify(testProfileData));
                    onboardingCompleted = true;
                    sessionStorage.setItem('onboardingCompleted', 'true');
                    
                    // Update auth UI to show user info
                    updateAuthUI(user);
                    
                    document.getElementById('onboarding-modal').classList.add('hidden');
                    showOnboardingComplete();
                    
                    setTimeout(() => {
                        hideAuthGate();
                        switchTab('planner');
                    }, 2000);
                }
            }
        }

        function resetOnboarding() {
            if (confirm('Are you sure you want to restart the onboarding process?')) {
                onboardingConversation = [];
                onboardingStep = 0;
                userOnboardingData = {};
                onboardingCompleted = false; // Reset completion flag
                sessionStorage.removeItem('onboardingCompleted');
                const user = window.mealPlannerAPI.getCurrentUser();
                if (user) {
                    startAIOnboarding(user);
                }
            }
        }

        async function logoutAndExit() {
            if (confirm('Are you sure you want to logout and exit?')) {
                try {
                    await window.mealPlannerAPI.signOut();
                    document.getElementById('onboarding-modal').classList.add('hidden');
                    showAuthGate();
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }

        function showTextInput(placeholder = "Type your response...") {
            const chatContainer = document.getElementById('onboarding-chat');
            
            // Remove any existing input
            const existingInput = document.getElementById('onboarding-input');
            if (existingInput) {
                existingInput.remove();
            }
            
            const inputDiv = document.createElement('div');
            inputDiv.className = 'mb-6 text-left max-w-2xl';
            inputDiv.id = 'onboarding-input';
            
            inputDiv.innerHTML = `
                <div class="bg-white border-2 border-blue-200 rounded-xl p-4 shadow-sm">
                    <textarea 
                        id="user-response-input" 
                        placeholder="${placeholder}"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        rows="3"
                        style="min-height: 80px;"
                    ></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-sm text-gray-500">Take your time - the more you tell me, the better I can help!</span>
                        <button onclick="submitUserResponse()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                            Send ‚Üí
                        </button>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(inputDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Focus the textarea
            setTimeout(() => {
                const textarea = document.getElementById('user-response-input');
                if (textarea) {
                    textarea.focus();
                    // Add enter key handler
                    textarea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            submitUserResponse();
                        }
                    });
                }
            }, 100);
        }

        function showDisplayNameAndLifeStage() {
            const chatContainer = document.getElementById('onboarding-chat');
            
            // Remove any existing input
            const existingInput = document.getElementById('onboarding-input');
            if (existingInput) {
                existingInput.remove();
            }
            
            const inputDiv = document.createElement('div');
            inputDiv.className = 'mb-6 text-left max-w-3xl';
            inputDiv.id = 'onboarding-input';
            
            inputDiv.innerHTML = `
                <div class="bg-white border-2 border-blue-200 rounded-xl p-4 shadow-sm">
                    <!-- Display Name Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">What would you like me to call you?</label>
                        <input 
                            type="text" 
                            id="display-name-input" 
                            value="${userOnboardingData.name || ''}"
                            placeholder="Your preferred name"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                    
                    <!-- Life Stage Section -->
                    <div class="mb-4">
                        <div class="text-sm text-gray-600 mb-3">What's your current life stage? (Select all that apply)</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 mb-4">
                            <button onclick="toggleQuickSelect(this, 'College/University student', true)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                College/University student
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Working professional', true)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Working professional
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Parent/caregiver', true)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Parent/caregiver
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Retired', true)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Retired
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Between jobs/career change', true)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Between jobs/career change
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Stay-at-home parent', true)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Stay-at-home parent
                            </button>
                        </div>
                    </div>
                    
                    <!-- Living Situation Section -->
                    <div class="mb-4">
                        <div class="text-sm text-gray-600 mb-3">What's your living situation like?</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 mb-4">
                            <button onclick="toggleQuickSelect(this, 'Live alone', false)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Live alone
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Live with partner/spouse', false)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Live with partner/spouse
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Live with family', false)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Live with family
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Shared housing/roommates', false)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Shared housing/roommates
                            </button>
                            <button onclick="toggleQuickSelect(this, 'Small apartment/studio', false)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                Small apartment/studio
                            </button>
                            <button onclick="toggleQuickSelect(this, 'House with full kitchen', false)" 
                                class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left">
                                House with full kitchen
                            </button>
                        </div>
                    </div>
                    
                    <textarea 
                        id="user-response-input" 
                        placeholder="Add any other details about your age, life stage, or living situation..."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        rows="2"
                        style="min-height: 60px;"
                    ></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-sm text-gray-500">Choose options above and/or add details below</span>
                        <button onclick="submitDisplayNameAndLifeStage()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                            Continue ‚Üí
                        </button>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(inputDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Focus the display name input
            setTimeout(() => {
                const nameInput = document.getElementById('display-name-input');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);
        }

        function submitDisplayNameAndLifeStage() {
            const displayName = document.getElementById('display-name-input').value.trim();
            const selectedButtons = document.querySelectorAll('.quick-select-btn.selected');
            const selectedValues = Array.from(selectedButtons).map(btn => btn.textContent.trim());
            const textInput = document.getElementById('user-response-input').value.trim();
            
            if (!displayName) {
                alert('Please enter your preferred name to continue.');
                return;
            }
            
            // Update user data with new name
            userOnboardingData.name = displayName;
            
            let response = '';
            if (selectedValues.length > 0) {
                response = selectedValues.join(', ');
            }
            if (textInput) {
                response += (response ? '. ' : '') + textInput;
            }
            
            if (!response) {
                response = 'Prefer not to specify life stage details';
            }
            
            const fullResponse = `My name is ${displayName}. ${response}`;
            
            // Add user's response to chat
            addOnboardingMessage('user', fullResponse);
            
            // Store the response
            userOnboardingData.responses.push({
                step: onboardingStep,
                question: getCurrentQuestion(),
                answer: fullResponse,
                display_name: displayName,
                selected_options: selectedValues,
                additional_text: textInput
            });
            
            // Remove input
            const inputDiv = document.getElementById('onboarding-input');
            if (inputDiv) {
                inputDiv.remove();
            }
            
            // Process the response with AI
            processConversationalResponse(fullResponse);
        }

        function showQuickSelectWithText(options, placeholder = "Add any additional details...", allowMultiple = false) {
            const chatContainer = document.getElementById('onboarding-chat');
            
            // Remove any existing input
            const existingInput = document.getElementById('onboarding-input');
            if (existingInput) {
                existingInput.remove();
            }
            
            const inputDiv = document.createElement('div');
            inputDiv.className = 'mb-6 text-left max-w-3xl';
            inputDiv.id = 'onboarding-input';
            
            const buttonGrid = options.map(option => `
                <button 
                    onclick="toggleQuickSelect(this, '${option}', ${allowMultiple})" 
                    class="quick-select-btn bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-400 text-gray-700 px-4 py-2 rounded-lg text-sm transition-all duration-200 text-left"
                >
                    ${option}
                </button>
            `).join('');
            
            inputDiv.innerHTML = `
                <div class="bg-white border-2 border-blue-200 rounded-xl p-4 shadow-sm">
                    <div class="mb-4">
                        <div class="text-sm text-gray-600 mb-3">${allowMultiple ? 'Select all that apply:' : 'Quick select (or type your own below):'}</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 mb-4">
                            ${buttonGrid}
                        </div>
                    </div>
                    <textarea 
                        id="user-response-input" 
                        placeholder="${placeholder}"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        rows="2"
                        style="min-height: 60px;"
                    ></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-sm text-gray-500">Choose options above and/or add details below</span>
                        <button onclick="submitQuickSelectResponse()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                            Continue ‚Üí
                        </button>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(inputDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function toggleQuickSelect(button, value, allowMultiple) {
            if (allowMultiple) {
                // Multi-select mode
                button.classList.toggle('selected');
                if (button.classList.contains('selected')) {
                    button.classList.remove('bg-gray-100', 'text-gray-700');
                    button.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                } else {
                    button.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                    button.classList.add('bg-gray-100', 'text-gray-700');
                }
            } else {
                // Single-select mode - deselect others
                const allButtons = document.querySelectorAll('.quick-select-btn');
                allButtons.forEach(btn => {
                    btn.classList.remove('selected', 'bg-blue-500', 'text-white', 'border-blue-500');
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                });
                
                // Select this one
                button.classList.add('selected', 'bg-blue-500', 'text-white', 'border-blue-500');
                button.classList.remove('bg-gray-100', 'text-gray-700');
            }
        }

        function submitQuickSelectResponse() {
            const selectedButtons = document.querySelectorAll('.quick-select-btn.selected');
            const selectedValues = Array.from(selectedButtons).map(btn => btn.textContent.trim());
            const textInput = document.getElementById('user-response-input').value.trim();
            
            let response = '';
            if (selectedValues.length > 0) {
                response = selectedValues.join(', ');
            }
            if (textInput) {
                response += (response ? '. ' : '') + textInput;
            }
            
            if (!response) {
                alert('Please select an option or type a response to continue.');
                return;
            }
            
            // Add user's response to chat
            addOnboardingMessage('user', response);
            
            // Store the response
            userOnboardingData.responses.push({
                step: onboardingStep,
                question: getCurrentQuestion(),
                answer: response,
                selected_options: selectedValues,
                additional_text: textInput
            });
            
            // Remove input
            const inputDiv = document.getElementById('onboarding-input');
            if (inputDiv) {
                inputDiv.remove();
            }
            
            // Process the response with AI
            processConversationalResponse(response);
        }

        async function submitUserResponse() {
            const textarea = document.getElementById('user-response-input');
            const response = textarea.value.trim();
            
            if (!response) {
                alert('Please type a response to continue.');
                return;
            }
            
            // Add user's response to chat
            addOnboardingMessage('user', response);
            
            // Store the response
            userOnboardingData.responses.push({
                step: onboardingStep,
                question: getCurrentQuestion(),
                answer: response
            });
            
            // Remove input
            const inputDiv = document.getElementById('onboarding-input');
            if (inputDiv) {
                inputDiv.remove();
            }
            
            // Process the response with AI
            await processConversationalResponse(response);
        }

        function getCurrentQuestion() {
            const questions = [
                "age and living situation",
                "accessibility and lifestyle considerations",
                "cooking relationship and experience",
                "dietary restrictions and preferences", 
                "kitchen equipment and tools",
                "work schedule and energy patterns",
                "cooking goals and challenges",
                "knife skills and techniques",
                "favorite cuisines and flavors",
                "meal planning style",
                "final preferences"
            ];
            return questions[onboardingStep] || "general question";
        }

        async function handleOnboardingChoice(value, text) {
            // Remove current options
            const currentOptions = document.getElementById('current-options');
            if (currentOptions) {
                currentOptions.remove();
            }
            
            // Add user's choice to chat
            addOnboardingMessage('user', text);
            
            // Process the choice and continue conversation
            await processOnboardingStep(value);
        }

        async function processConversationalResponse(userResponse) {
            onboardingStep++;
            updateOnboardingProgress(onboardingStep + 1, 11);
            
            // Show typing indicator
            showTypingIndicator();
            
            let nextQuestion = "";
            let nextPlaceholder = "";
            
            switch(onboardingStep) {
                case 1: // After age/living situation response
                    nextQuestion = await generateAccessibilityQuestion(userResponse);
                    // Show quick-select for accessibility needs
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'ADHD or executive function challenges',
                            'Depression or anxiety',
                            'Chronic fatigue or low energy',
                            'Physical disabilities or mobility issues',
                            'Sensory sensitivities (textures, sounds, smells)',
                            'Chronic illness or pain',
                            'Autism or other neurodivergence',
                            'None of the above'
                        ], "Add any other details about challenges that affect cooking...", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 2: // After accessibility response
                    nextQuestion = await generateCookingQuestion(userResponse);
                    nextPlaceholder = "Tell me about your relationship with cooking - love it, hate it, somewhere in between?";
                    break;
                    
                case 3: // After cooking experience response
                    nextQuestion = await generateDietaryQuestion(userResponse);
                    // Show quick-select for dietary needs
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'Vegetarian',
                            'Vegan',
                            'Gluten-free',
                            'Dairy-free/Lactose intolerant',
                            'Nut allergies',
                            'Low-carb/Keto',
                            'Low-sodium',
                            'Diabetic considerations',
                            'Kosher or Halal',
                            'No specific restrictions'
                        ], "Tell me about any other dietary needs, allergies, or preferences...", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 4: // After dietary response  
                    nextQuestion = await generateEquipmentQuestion(userResponse);
                    // Show quick-select for common kitchen equipment
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'Basic knives (chef\'s knife, paring knife)',
                            'Good quality knife set',
                            'Non-stick pans',
                            'Cast iron cookware',
                            'Instant Pot or pressure cooker',
                            'Slow cooker/Crock pot',
                            'Blender',
                            'Food processor',
                            'Stand mixer (KitchenAid style)',
                            'Air fryer',
                            'Rice cooker',
                            'Sheet pans and baking dishes',
                            'Very basic equipment only'
                        ], "List any other specific tools, appliances, or cookware you have...", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 5: // After equipment response
                    nextQuestion = await generateScheduleQuestion(userResponse);
                    // Show quick-select for schedule types
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'Regular 9-5 schedule',
                            'Shift work or irregular hours',
                            'Very busy/high-stress job',
                            'Student schedule',
                            'Parent with young children',
                            'Work from home',
                            'Retired or flexible schedule',
                            'Weekends are my main cooking time',
                            'Evenings are my main cooking time',
                            'I prefer to cook in large batches'
                        ], "Describe your typical week, busy periods, and when you have energy to cook...", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 6: // After schedule response
                    nextQuestion = await generateGoalsQuestion(userResponse);
                    // Show quick-select for goals and challenges
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'Eat healthier meals',
                            'Save money on food',
                            'Reduce food waste',
                            'Save time during busy weekdays',
                            'Learn new cooking skills',
                            'Meal prep for the week',
                            'Feed my family better',
                            'Manage dietary restrictions easier',
                            'Reduce decision fatigue (what to cook)',
                            'Stop relying on takeout so much'
                        ], "What other goals or challenges do you have with meal planning?", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 7: // After goals response
                    nextQuestion = await generateSkillsQuestion(userResponse);
                    // Show quick-select for skill levels
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'Very comfortable with knife work',
                            'Basic knife skills (can chop safely)',
                            'Still learning knife techniques',
                            'Confident following detailed recipes',
                            'Prefer simple, minimal-step recipes',
                            'Good at improvising and adapting recipes',
                            'Comfortable with most cooking methods',
                            'Prefer one-pan or sheet-pan meals',
                            'Love trying complex new techniques',
                            'Stick to familiar, tried-and-true methods'
                        ], "Tell me more about your cooking skills and comfort level...", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 8: // After skills response
                    nextQuestion = await generateCuisineQuestion(userResponse);
                    // Show quick-select for cuisine preferences
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'Italian (pasta, pizza, Mediterranean)',
                            'Asian (Chinese, Thai, Japanese, Korean)',
                            'Mexican/Latin American',
                            'Indian and spicy foods',
                            'Comfort foods (mac and cheese, casseroles)',
                            'Fresh and healthy (salads, grain bowls)',
                            'BBQ and grilled foods',
                            'Soups and stews',
                            'Breakfast foods anytime',
                            'Simple American classics',
                            "I'm open to trying anything"
                        ], "What other flavors, cuisines, or types of food do you enjoy?", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 9: // After cuisine response
                    nextQuestion = await generatePlanningQuestion(userResponse);
                    // Show quick-select for planning styles
                    setTimeout(() => {
                        hideTypingIndicator();
                        addOnboardingMessage('ai', nextQuestion);
                        showQuickSelectWithText([
                            'Batch cook on weekends',
                            'Cook fresh each day',
                            'Prep ingredients in advance, cook later',
                            'Make large portions for leftovers',
                            'Plan a week at a time',
                            'Wing it day by day',
                            'Theme nights (Taco Tuesday, etc.)',
                            'Rotate between favorite meals',
                            'Always trying new recipes',
                            'Keep backup frozen/easy meals ready'
                        ], "How else do you like to approach meal planning and prep?", true);
                    }, 1500 + Math.random() * 1000);
                    return;
                    
                case 10: // After planning response
                    nextQuestion = await generateFinalQuestion(userResponse);
                    nextPlaceholder = "Any final thoughts, specific needs, or things I should know to help you succeed?";
                    break;
                    
                case 11: // Final response - complete onboarding
                    hideTypingIndicator();
                    await completeConversationalOnboarding();
                    return;
            }
            
            // Wait a bit to simulate AI thinking
            setTimeout(() => {
                hideTypingIndicator();
                addOnboardingMessage('ai', nextQuestion);
                showTextInput(nextPlaceholder);
            }, 1500 + Math.random() * 1000); // 1.5-2.5 seconds
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('onboarding-chat');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'mb-4 text-left';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="inline-block p-4 rounded-xl bg-gray-100 text-gray-600 border border-gray-200">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <span class="text-sm">AI is thinking...</span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function getAIResponse(prompt) {
            // For now, use smart fallback responses
            // TODO: Add Hugging Face token via Vercel environment variables for AI responses
            return getFallbackResponse();
            
            /* Disabled until token is configured via Vercel environment variables
            try {
                if (!window.VITE_HUGGINGFACE_TOKEN) {
                    return getFallbackResponse();
                }
                
                // Using Hugging Face's free inference API with a conversational model
                const response = await fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.VITE_HUGGINGFACE_TOKEN}`
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_length: 100,
                            temperature: 0.7,
                            do_sample: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('AI service unavailable');
                }

                const data = await response.json();
                return data[0]?.generated_text || getFallbackResponse();
                
            } catch (error) {
                console.error('AI response error:', error);
                return getFallbackResponse();
            }
            */
        }

        // Intelligent question generation based on user responses
        
        async function generateAccessibilityQuestion(ageResponse) {
            const response = ageResponse.toLowerCase();
            
            if (response.includes('student') || response.includes('college') || response.includes('university')) {
                return `Thanks for sharing! Student life can be challenging for meal planning - tight budgets, shared kitchens, irregular schedules. üéì

**Now for something important:** I want to make sure the meal plans I suggest actually work for your brain and body. 

Do you have anything that affects how you approach cooking or meal planning? This could be **ADHD** (trouble with executive function), **depression or anxiety** (affects motivation/energy), **physical limitations** (mobility, chronic pain, fatigue), **sensory issues** (textures, sounds, smells), or anything else I should know about?

There's no judgment here - I just want to suggest strategies that work WITH your brain and situation, not against them.`;
            } else if (response.includes('working') || response.includes('professional') || response.includes('job')) {
                return `Got it! Working full-time definitely impacts how much time and energy you have for cooking. ‚ö°

**Here's something important I need to know:** Do you have any conditions or challenges that affect how you approach cooking and meal planning? 

This could include things like **ADHD** (executive function challenges), **chronic fatigue**, **depression/anxiety** (affecting motivation), **physical limitations**, **sensory sensitivities**, or anything else that influences your relationship with food prep.

I'm asking because different brains work differently, and I want to suggest meal planning strategies that actually fit YOUR situation.`;
            } else if (response.includes('parent') || response.includes('kids') || response.includes('family')) {
                return `Parenting adds a whole extra layer to meal planning! üë®‚Äçüë©‚Äçüëß‚Äçüë¶

**I want to ask about something important:** Beyond the usual parenting challenges, do you have any personal factors that affect your cooking and meal planning? 

Things like **ADHD** (executive function challenges), **postpartum depression/anxiety**, **chronic fatigue**, **physical limitations**, **sensory processing issues**, or anything else that impacts how you approach food and cooking?

Understanding this helps me suggest realistic strategies that work for your actual life, not just theoretical meal plans.`;
            } else {
                return `Thanks for sharing your life situation! 

**Now for something really important:** I believe meal planning should work for ALL brains and bodies, not just neurotypical, able-bodied people.

Do you have any conditions, challenges, or considerations that affect how you approach cooking and meal planning? This could include:

‚Ä¢ **Neurodivergence** (ADHD, autism, executive function challenges)
‚Ä¢ **Mental health** (depression, anxiety affecting motivation/energy)  
‚Ä¢ **Physical factors** (chronic pain, fatigue, mobility limitations)
‚Ä¢ **Sensory issues** (textures, sounds, smells in cooking)
‚Ä¢ **Chronic illness** or other health considerations

Or maybe nothing specific comes to mind - that's totally fine too! I just want to make sure my suggestions actually work for YOU.`;
            }
        }

        async function generateCookingQuestion(accessibilityResponse) {
            const response = accessibilityResponse.toLowerCase();
            
            if (response.includes('adhd') || response.includes('executive')) {
                return `Thank you for sharing that! ADHD can definitely impact cooking - from remembering steps to managing time to dealing with sensory aspects. I'll keep that in mind for suggestions. üß†

**Now let's talk about cooking itself:** How do you currently feel about cooking? 

Are you someone who finds it overwhelming (too many steps, sensory overload), or do you actually enjoy it when you can focus? Do you prefer really simple recipes, or do you like having something engaging to hyperfocus on?

Understanding your relationship with cooking will help me suggest recipes and strategies that work WITH your ADHD brain.`;
            } else if (response.includes('depression') || response.includes('anxiety') || response.includes('mental')) {
                return `I appreciate you sharing that. Mental health definitely affects our relationship with food and cooking - some days you have energy, others you don't, and that's completely normal. üíô

**Let's talk about cooking:** On your good days, how do you feel about cooking? Do you enjoy it, find it therapeutic, or is it still a chore?

And on harder days, what feels manageable? Are you someone who can handle very simple assembly, or do you prefer having easy backup options ready to go?

I want to suggest meal strategies that work for both your good days AND your challenging ones.`;
            } else if (response.includes('chronic') || response.includes('fatigue') || response.includes('pain') || response.includes('mobility')) {
                return `Thank you for trusting me with that information. Chronic conditions add real constraints to cooking, and I want to make sure my suggestions respect your energy and physical limits. üåü

**About cooking:** How does your condition typically affect your ability to cook? 

Do you have good days and bad days? Are there specific tasks that are harder (standing for long periods, heavy lifting, repetitive motions)? Do you prefer to batch cook when you're feeling good, or do you need consistently simple options?

Understanding your patterns will help me suggest realistic meal planning that conserves your energy for what matters most.`;
            } else if (response.includes('sensory') || response.includes('autism') || response.includes('sensitive')) {
                return `Thanks for sharing! Sensory considerations are so important in cooking - textures, smells, sounds can all impact the experience. üåà

**Let's talk about cooking:** Are there specific sensory aspects of cooking that work well for you or that you find challenging?

For example, do you enjoy the process of chopping and preparing ingredients, or do certain textures/smells make it difficult? Are there cooking methods you prefer (like baking vs. stovetop) or ingredients that are particularly appealing or off-putting?

I want to suggest recipes and techniques that feel good to make, not just good to eat.`;
            } else if (response.includes('none') || response.includes('nothing') || response.includes('not really')) {
                return `Perfect! Thanks for letting me know. üòä

**Now let's dive into cooking:** What's your current relationship with cooking like? 

Are you someone who genuinely enjoys spending time in the kitchen, or do you see it more as a necessary chore? Are you confident with basics, or still building skills? Do you like following detailed recipes, or prefer to wing it?

There's no right answer here - I just want to understand where you're starting from so I can suggest recipes and approaches that match your comfort level and interests.`;
            } else {
                return `Thank you for sharing that with me. I'll definitely keep those considerations in mind when suggesting recipes and meal planning strategies. üí™

**Now let's talk about cooking itself:** What's your current relationship with cooking?

Do you enjoy it despite any challenges, or do you find it stressful? Are there aspects of cooking that work particularly well for you, or specific things that make it harder?

Understanding both your challenges AND what you enjoy about cooking will help me suggest approaches that feel sustainable and enjoyable.`;
            }
        }
        
        async function generateDietaryQuestion(cookingResponse) {
            const response = cookingResponse.toLowerCase();
            
            if (response.includes('beginner') || response.includes('new') || response.includes('starting')) {
                return `I can see you're getting started with cooking - that's exciting! üåü Learning to cook is such a rewarding journey.

Since you're building your skills, it's important I know about any **dietary restrictions, allergies, or food preferences** you have. This way I can suggest recipes that are both beginner-friendly AND safe/enjoyable for you to eat.

Do you have any foods you need to avoid, or particular preferences I should know about?`;
            } else if (response.includes('love') || response.includes('passion') || response.includes('enjoy')) {
                return `I love that enthusiasm for cooking! üî• There's nothing better than someone who truly enjoys time in the kitchen.

Since you're passionate about cooking, I want to make sure I understand your **dietary landscape** - any restrictions, allergies, specific nutrition goals, or strong food preferences that guide your cooking choices?

Even if you don't have restrictions, knowing what foods you gravitate toward helps me suggest recipes you'll actually want to make.`;
            } else if (response.includes('time') || response.includes('busy') || response.includes('quick')) {
                return `I totally get the time crunch - cooking when you're busy is a real challenge! ‚è∞

Since time is a factor for you, it's even more important that I suggest recipes with ingredients you can actually eat and enjoy. No point spending your precious cooking time on something you can't have!

**Tell me about any dietary restrictions, allergies, or food preferences** that would rule out certain ingredients or recipe types.`;
            } else {
                return `Thanks for sharing that context about your cooking experience! 

Now I need to understand your **dietary needs and preferences**. This is crucial because there's no point suggesting amazing recipes if they contain ingredients you can't or won't eat.

Do you have any dietary restrictions, food allergies, nutritional goals, or strong preferences I should know about?`;
            }
        }

        async function generateEquipmentQuestion(dietaryResponse) {
            const response = dietaryResponse.toLowerCase();
            
            if (response.includes('none') || response.includes('no restrictions') || response.includes('eat everything')) {
                return `Perfect! Having flexibility with ingredients makes meal planning so much easier. üëç

Now let's talk about your **kitchen setup**. This is where I can really help optimize your cooking experience. I don't just want to know "basic" or "advanced" - I want to know specifically what tools and appliances you have.

**List out your kitchen equipment** - things like knives, pans, small appliances, anything you cook with. Be specific! For example: "I have a decent 8-inch chef's knife, one non-stick pan, a slow cooker, basic blender..." The more detail, the better I can match recipes to what you can actually make.`;
            } else if (response.includes('vegetarian') || response.includes('vegan') || response.includes('plant')) {
                return `Got it! Plant-based cooking opens up so many delicious possibilities. üå±

Since you'll be working with lots of vegetables, grains, and plant proteins, your **kitchen equipment** becomes really important. Different tools can make plant-based cooking much easier and more enjoyable.

**Tell me specifically what kitchen tools and appliances you have available.** Things like: quality knives, cutting boards, pans, blenders, food processors, rice cookers, etc. Don't just say "basic" - list out what you actually own!`;
            } else if (response.includes('allerg') || response.includes('gluten') || response.includes('sensitive')) {
                return `I appreciate you sharing those dietary needs - managing allergies or sensitivities while cooking requires extra attention. ü©∫

Your **kitchen equipment** becomes even more important when you need to avoid cross-contamination or prepare foods in specific ways.

**What cooking tools and appliances do you currently have?** Be specific about pans, knives, small appliances, etc. Also, do you have separate equipment for allergen-free cooking, or is that something we need to consider?`;
            } else {
                return `Thanks for the insight into your dietary preferences! That helps me understand what types of recipes will work for you.

Now I need to know about your **kitchen equipment situation**. I'm not looking for vague categories here - I want to know exactly what tools and appliances you have to work with.

**List your kitchen gear specifically** - knives, pans, appliances, anything you use for cooking. The more detailed you are, the better I can suggest recipes that match what you can actually make with your current setup.`;
            }
        }

        async function generateScheduleQuestion(equipmentResponse) {
            const response = equipmentResponse.toLowerCase();
            
            if (response.includes('instant pot') || response.includes('pressure cooker') || response.includes('slow cooker')) {
                return `Nice! I see you have some great time-saving appliances there. Those can be game-changers for meal prep and busy schedules. üç≤

Speaking of schedules - this is crucial for meal planning that actually works in real life. I need to understand **when you have time to cook, when you're busy, and what your energy levels are like** throughout the week.

**Describe your typical schedule** - work hours, busy periods, when you get home, weekend availability. Also, are you someone who comes home exhausted, or do you have energy for cooking? Do you work shifts, have irregular hours, or a pretty predictable routine?`;
            } else if (response.includes('minimal') || response.includes('basic') || response.includes('just') || response.includes('only')) {
                return `I see you're working with a more minimal setup - that's totally doable! Some of the best meals come from simple tools and techniques. üî•

Since your equipment is limited, **your schedule and energy levels** become even more important for planning. I need to suggest recipes that work within both your equipment constraints AND your time/energy reality.

**Tell me about your typical week** - when do you have time to cook? Are you usually tired when you get home, or do you have energy for food prep? Do you work standard hours, shifts, or something irregular?`;
            } else if (response.includes('knife') && response.includes('good') || response.includes('sharp') || response.includes('decent')) {
                return `Great to hear you have good knife skills covered! A sharp knife makes everything in the kitchen better. üî™

Now let's talk about **your schedule and energy patterns**. Even with good equipment, meal planning fails if it doesn't account for real life - work stress, busy periods, days when you just don't have it in you to cook.

**What's your typical week like?** When do you have time to cook? Do you come home energized or exhausted? Are you working standard hours, night shifts, freelance schedule? Help me understand your rhythm so I can suggest meals that fit your actual life.`;
            } else {
                return `Thanks for that detailed equipment rundown! That gives me a good sense of what recipes are actually feasible for you.

Now I need to understand **your schedule and energy patterns**. This is where meal planning gets real - it doesn't matter how good a recipe is if you don't have time or energy to make it.

**Walk me through your typical week** - work schedule, busy periods, when you usually cook, how tired you are when you get home. Are you someone with steady energy, or does it vary a lot day to day?`;
            }
        }

        async function generateGoalsQuestion(scheduleResponse) {
            return `That schedule context is really helpful - I can already see some patterns that will influence what types of meals make sense for you. üìÖ

Now let's get to the heart of why you're here: **What are you hoping to achieve with meal planning?** This isn't a generic question - I want to know YOUR specific goals and challenges.

Maybe you want to eat healthier, save money, reduce food waste, spend less time deciding what to cook, meal prep for busy weeks, learn new skills, or something completely different. What's driving you to set up a meal planning system right now?`;
        }

        async function generateSkillsQuestion(goalsResponse) {
            const response = goalsResponse.toLowerCase();
            
            if (response.includes('learn') || response.includes('skill') || response.includes('better') || response.includes('improve')) {
                return `I love that you want to build your cooking skills! That's such a rewarding goal. üìà

Since you're focused on learning, I need to understand **your current skill level** more specifically. Not just "beginner" or "intermediate" - but what you're actually comfortable with right now.

**How confident are you with things like:** knife work and chopping, following complex recipes, timing multiple dishes, basic techniques like saut√©ing/roasting/braising? What feels easy vs. what feels intimidating? This helps me suggest recipes that stretch your skills without overwhelming you.`;
            } else if (response.includes('time') || response.includes('quick') || response.includes('efficient') || response.includes('fast')) {
                return `Totally understand the need for efficiency! Time is precious, and cooking shouldn't feel like a chore when you're already busy. ‚è±Ô∏è

Since time is a priority, I need to know **what cooking skills you can deploy quickly** vs. what slows you down. No point suggesting 30-minute meals if chopping vegetables takes you 20 minutes!

**How comfortable and fast are you with:** knife work, multitasking in the kitchen, following recipes without constantly checking, basic cooking techniques? What kitchen tasks feel smooth vs. which ones slow you down?`;
            } else {
                return `Those goals make a lot of sense! Understanding what you want to achieve helps me suggest the right types of recipes and planning approaches.

Now I need to assess **your current cooking skills** more specifically. This isn't about labeling yourself - it's about understanding what techniques you're comfortable with so I can suggest appropriate recipes.

**How confident are you with:** knife skills and prep work, following multi-step recipes, timing multiple components, various cooking methods (saut√©ing, roasting, etc.)? What feels natural vs. what still requires concentration?`;
            }
        }

        async function generateCuisineQuestion(skillsResponse) {
            return `That skill assessment is really useful - I can match recipe complexity to what you're comfortable with while maybe pushing you just slightly outside your comfort zone. üéØ

Let's talk **flavors and cuisines**. This is where cooking gets fun! I don't want to just suggest "healthy chicken recipes" - I want to understand what actually excites your taste buds.

**What flavors, cuisines, or types of food do you find yourself craving or ordering?** Are you drawn to spicy foods, comfort foods, fresh and light dishes, rich and hearty meals? Any particular cuisines that speak to you - or ones you're curious to try?`;
        }

        async function generatePlanningQuestion(cuisineResponse) {
            return `Excellent! Those flavor preferences give me a great direction for recipe suggestions. Food should be delicious, not just functional! üòã

**Now let's talk strategy:** How do you want to approach the actual meal planning and prep? I'm not talking about your cooking skills - I mean your strategy for organizing meals throughout the week.

Do you prefer to batch cook on weekends, cook fresh each day, prep ingredients in advance and assemble later, or some combination? What's worked for you before, and what definitely hasn't worked?`;
        }

        async function generateFinalQuestion(planningResponse) {
            return `Perfect! I think I have a really solid understanding of your situation now. üéØ

**One last thing:** Is there anything else I should know to help you succeed with meal planning? 

Maybe specific challenges you face that we haven't covered, foods you absolutely hate, cooking disasters you want to avoid, family members with picky eating habits, budget constraints, or just any other thoughts about what would make meal planning actually work for your life?

This is your chance to add anything that feels important - or just say you're all set if we've covered everything!`;
        }

        async function completeConversationalOnboarding() {
            const responses = userOnboardingData.responses;
            
            // Create a comprehensive summary
            const summaryMessage = `üéâ **Fantastic! I now have a complete picture of your cooking situation.**

Here's what I learned about you:

**Age & Living Situation:** ${responses[0]?.answer || 'Not specified'}

**Accessibility Considerations:** ${responses[1]?.answer || 'Not specified'}

**Cooking Background:** ${responses[2]?.answer || 'Not specified'}

**Dietary Needs:** ${responses[3]?.answer || 'Not specified'}

**Kitchen Setup:** ${responses[4]?.answer || 'Not specified'}

**Schedule & Energy:** ${responses[5]?.answer || 'Not specified'}

**Goals & Challenges:** ${responses[6]?.answer || 'Not specified'}

**Skills & Comfort Level:** ${responses[7]?.answer || 'Not specified'}

**Flavor Preferences:** ${responses[8]?.answer || 'Not specified'}

**Planning Style:** ${responses[9]?.answer || 'Not specified'}

**Additional Notes:** ${responses[10]?.answer || 'Not specified'}

This detailed profile means I can suggest recipes that actually fit YOUR life - not generic meal plans that ignore your equipment, schedule, and preferences. Ready to start cooking?`;
            
            addOnboardingMessage('ai', summaryMessage);
            
            // Show completion button
            const chatContainer = document.getElementById('onboarding-chat');
            const completeDiv = document.createElement('div');
            completeDiv.className = 'mb-6 text-center';
            const completeButton = document.createElement('button');
            completeButton.className = 'bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl text-lg';
            completeButton.textContent = 'üöÄ Start My Personalized Meal Planning!';
            completeButton.onclick = completeDetailedOnboarding;
            completeDiv.appendChild(completeButton);
            chatContainer.appendChild(completeDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function getFallbackResponse() {
            const fallbacks = [
                "That's really helpful information - let me ask you more about that.",
                "I can see some patterns already that will help with suggestions.",
                "Great details! This is exactly what I need to know.",
                "Perfect! That gives me a much clearer picture."
            ];
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        async function completeDetailedOnboarding() {
            try {
                console.log('üîÑ Starting conversational onboarding completion...');
                console.log('üìä User responses:', userOnboardingData.responses);
                
                // Parse responses into structured data
                const responses = userOnboardingData.responses;
                const profileData = {
                    display_name: responses[0]?.display_name || userOnboardingData.name,
                    onboarding_type: 'conversational',
                    age_range: responses[0]?.answer || '',
                    living_situation: responses[0]?.answer || '', // Extracted from step 1 response
                    accessibility_needs: responses[1]?.answer || '',
                    cooking_background: responses[2]?.answer || '',
                    dietary_needs: responses[3]?.answer || '',
                    kitchen_equipment: responses[4]?.answer || '',
                    schedule_energy: responses[5]?.answer || '',
                    goals_challenges: responses[6]?.answer || '',
                    skills_comfort: responses[7]?.answer || '',
                    flavor_preferences: responses[8]?.answer || '',
                    planning_style: responses[9]?.answer || '',
                    full_conversation: responses,
                    onboarding_completed: true,
                    onboarding_date: new Date().toISOString(),
                    profile_version: '5.0' // Enhanced inclusive version
                };

                console.log('üíæ Profile data to save:', profileData);
                
                // Check if Supabase is available
                if (!window.mealPlannerAPI.isSupabaseReady()) {
                    console.log('‚ö†Ô∏è Supabase not available, saving to localStorage');
                    localStorage.setItem('userProfile', JSON.stringify(profileData));
                    
                    // Set completion flag to prevent restart
                    onboardingCompleted = true;
                    
                    // Hide onboarding modal
                    document.getElementById('onboarding-modal').classList.add('hidden');
                    showOnboardingComplete();
                    setTimeout(() => {
                        hideAuthGate();
                        switchTab('planner');
                    }, 2000);
                    return;
                }

                console.log('‚òÅÔ∏è Saving to Supabase...');
                const result = await window.mealPlannerAPI.updateUserProfile(profileData);
                console.log('‚úÖ Profile saved successfully:', result);
                
                // Set completion flag to prevent restart
                onboardingCompleted = true;
                
                // Wait a moment for database consistency then verify save
                setTimeout(async () => {
                    try {
                        const savedProfile = await window.mealPlannerAPI.getUserProfile();
                        console.log('üîç Verification - saved profile:', savedProfile);
                    } catch (e) {
                        console.log('‚ö†Ô∏è Could not verify profile save:', e);
                    }
                }, 500);
                
                // Hide onboarding modal
                document.getElementById('onboarding-modal').classList.add('hidden');
                
                // Show success message and start normal app
                showOnboardingComplete();
                
                // Switch to planner after a brief delay
                setTimeout(() => {
                    hideAuthGate();
                    switchTab('planner');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error completing onboarding:', error);
                console.error('Error details:', error.message, error.stack);
                
                // Fallback to localStorage if Supabase fails
                try {
                    console.log('üîÑ Falling back to localStorage...');
                    const responses = userOnboardingData.responses;
                    const profileData = {
                        display_name: responses[0]?.display_name || userOnboardingData.name,
                        onboarding_type: 'conversational',
                        age_range: responses[0]?.answer || '',
                        living_situation: responses[0]?.answer || '', // Extracted from step 1 response
                        accessibility_needs: responses[1]?.answer || '',
                        cooking_background: responses[2]?.answer || '',
                        dietary_needs: responses[3]?.answer || '',
                        kitchen_equipment: responses[4]?.answer || '',
                        schedule_energy: responses[5]?.answer || '',
                        goals_challenges: responses[6]?.answer || '',
                        skills_comfort: responses[7]?.answer || '',
                        flavor_preferences: responses[8]?.answer || '',
                        planning_style: responses[9]?.answer || '',
                        full_conversation: responses,
                        onboarding_completed: true,
                        onboarding_date: new Date().toISOString(),
                        profile_version: '5.0' // Enhanced inclusive version
                    };
                    
                    localStorage.setItem('userProfile', JSON.stringify(profileData));
                    console.log('‚úÖ Saved to localStorage as fallback');
                    
                    // Set completion flag to prevent restart
                    onboardingCompleted = true;
                    
                    // Hide onboarding modal
                    document.getElementById('onboarding-modal').classList.add('hidden');
                    showOnboardingComplete();
                    setTimeout(() => {
                        hideAuthGate();
                        switchTab('planner');
                    }, 2000);
                    
                } catch (fallbackError) {
                    console.error('‚ùå Even localStorage failed:', fallbackError);
                    alert('Failed to save your preferences. Please try again or contact support.');
                }
            }
        }

        function showOnboardingComplete() {
            // Create a temporary success overlay
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed inset-0 bg-blue-500 bg-opacity-90 flex items-center justify-center z-50';
            successDiv.innerHTML = `
                <div class="text-center text-white">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 class="text-3xl font-bold mb-2">Welcome to Your Meal Planner!</h2>
                    <p class="text-xl">Your personalized setup is complete</p>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 2000);
        }

        // Override auth state change to handle onboarding
        window.addEventListener('authStateChange', (event) => {
            const { user } = event.detail;
            updateAuthUI(user);
            
            if (user) {
                checkOnboardingStatus(user);
            } else {
                showAuthGate();
            }
        });

        // Initialize auth UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Page loaded, initializing auth...');
            
            // Hide loading fallback
            const loadingFallback = document.getElementById('loading-fallback');
            if (loadingFallback) {
                loadingFallback.style.display = 'none';
            }
            
            // Check authentication immediately
            function initializeAuth() {
                console.log('üîç Checking if API is ready...', !!window.mealPlannerAPI);
                if (window.mealPlannerAPI) {
                    console.log('‚úÖ API ready, checking authentication...');
                    checkAuthenticationRequired();
                } else {
                    console.log('‚è≥ API not ready, retrying...');
                    // If API not loaded yet, try again shortly
                    setTimeout(initializeAuth, 100);
                }
            }
            
            initializeAuth();
        });
    </script>
</body>
</html>