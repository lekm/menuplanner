<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Meal Planner - Auth Enabled</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuration -->
    <script>
    // EmailJS configuration
    window.VITE_EMAILJS_USER_ID = 'yyKfiq-hIQgATGWPi';
    window.VITE_EMAILJS_SERVICE_ID = 'service_0jfc4xc';
    window.VITE_EMAILJS_TEMPLATE_ID = 'template_0ta7il9';
    
    // Supabase configuration
    window.VITE_SUPABASE_URL = 'https://vriusyvuqwlozqqcpbke.supabase.co';
    window.VITE_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyaXVzeXZ1cXdsb3pxcWNwYmtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzOTQwMDEsImV4cCI6MjA2Nzk3MDAwMX0.AoKGvVhxDzAaYOAgSVwt4Jhve9-Ck4o2BiD3iHiV8oE';
    
    // Debug Supabase loading
    console.log('Supabase URL:', window.VITE_SUPABASE_URL);
    console.log('Supabase Key present:', !!window.VITE_SUPABASE_ANON_KEY);
    console.log('Supabase global:', !!window.supabase);
    </script>
    
    <!-- Load our API layer and bug reporting system -->
    <script src="js/api.js"></script>
    <script src="js/bug-report.js"></script>
    <style>
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: .8;
      }
    }
    .icon-btn.selected {
        background-color: #3b82f6;
        color: white;
    }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="w-full px-2 py-4">
        <!-- Header with Auth -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl md:text-4xl font-bold text-gray-800">Weekly Meal Planner</h1>
            
            <!-- Auth Section -->
            <div id="auth-section" class="flex items-center gap-2">
                <!-- User Info (when logged in) -->
                <div id="user-info" class="hidden flex items-center gap-2">
                    <img id="user-avatar" src="" alt="User Avatar" class="w-8 h-8 rounded-full hidden">
                    <span id="user-name" class="text-sm text-gray-700"></span>
                    <button onclick="showUserMenu()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Login Button (when not logged in) -->
                <button id="login-btn" onclick="showAuthModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-200">
                    Login
                </button>
                
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg shadow-md p-1 flex flex-wrap">
                <button onclick="switchTab('planner')" id="tab-planner" class="px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors bg-blue-500 text-white">📅 Planner</button>
                <button onclick="switchTab('recipes')" id="tab-recipes" class="px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors text-gray-700 hover:bg-gray-100">📖 My Recipes</button>
                <button onclick="switchTab('templates')" id="tab-templates" class="px-3 md:px-4 py-2 rounded-md text-xs md:text-sm font-medium transition-colors text-gray-700 hover:bg-gray-100">📋 Templates</button>
            </div>
        </div>
        
        <!-- Planner Tab Content -->
        <div id="planner-content">
        
        <!-- Energy Level Selector -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg shadow-md p-2 md:p-4 flex flex-wrap gap-2 md:gap-4">
                <span class="text-xs md:text-sm font-medium text-gray-700 self-center w-full md:w-auto text-center md:text-left">Today's Energy:</span>
                <button onclick="setEnergyLevel('high')" id="energy-high" class="px-3 py-2 md:px-4 rounded-md text-xs md:text-sm font-medium transition-colors bg-green-100 text-green-800 hover:bg-green-200 flex-1 md:flex-none">🚀 High Energy</button>
                <button onclick="setEnergyLevel('medium')" id="energy-medium" class="px-3 py-2 md:px-4 rounded-md text-xs md:text-sm font-medium transition-colors bg-yellow-100 text-yellow-800 hover:bg-yellow-200 flex-1 md:flex-none">⚡ Medium Energy</button>
                <button onclick="setEnergyLevel('low')" id="energy-low" class="px-3 py-2 md:px-4 rounded-md text-xs md:text-sm font-medium transition-colors bg-red-100 text-red-800 hover:bg-red-200 flex-1 md:flex-none">😴 Survival Mode</button>
            </div>
        </div>
        
        <!-- Meal Suggestions Panel -->
        <div id="suggestions-panel" class="hidden mb-6 mx-auto max-w-4xl">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-900 mb-2">Suggested Meals for Your Energy Level:</h3>
                <div id="suggestions-content" class="text-sm text-blue-800"></div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-2 w-full">
            <!-- Monday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-red-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Monday</h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tuesday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-orange-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Tuesday <span class="text-xs text-green-600">(WFH)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wednesday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-yellow-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Wednesday</h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thursday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-green-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Thursday</h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Friday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-blue-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Friday <span class="text-xs text-orange-600">(WFH→Bar)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter breakfast meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Pre-Bar Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Quick meal before bar shift..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saturday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-indigo-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Saturday <span class="text-xs text-red-600">(Bar Day)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Late Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Recovery breakfast..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Pre-Bar Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Quick meal before bar shift..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sunday -->
            <div class="bg-white rounded-lg shadow-md p-2 border-t-4 border-violet-500">
                <h2 class="text-sm md:text-lg font-semibold text-gray-800 mb-2 text-center">Sunday <span class="text-xs text-blue-600">(Recovery)</span></h2>
                
                <div class="space-y-2">
                    <div class="bg-yellow-50 p-2 rounded-md border-l-4 border-yellow-400">
                        <h3 class="font-medium text-yellow-800 mb-1 text-xs md:text-sm">Late Breakfast</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Recovery breakfast..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-2 rounded-md border-l-4 border-orange-400">
                        <h3 class="font-medium text-orange-800 mb-1 text-xs md:text-sm">Lunch</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter lunch meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-2 rounded-md border-l-4 border-purple-400">
                        <h3 class="font-medium text-purple-800 mb-1 text-xs md:text-sm">Dinner</h3>
                        <div class="relative">
                            <textarea 
                                class="w-full p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs md:text-sm" 
                                rows="3" 
                                placeholder="Enter dinner meal..."></textarea>
                            <button onclick="showRecipePicker(this)" class="absolute top-1 right-1 text-gray-400 hover:text-blue-500 text-sm">📖</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save/Clear buttons -->
        <div class="flex flex-wrap justify-center mt-8 gap-2">
            <button 
                onclick="saveMealPlan()" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                💾 Save Plan
            </button>
            <button 
                onclick="clearMealPlan()" 
                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                🗑️ Clear All
            </button>
            <button 
                onclick="generateGroceryList()" 
                class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                🛒 Grocery List
            </button>
            <button 
                onclick="saveAsTemplate()" 
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-200 text-sm md:text-base">
                📋 Save Template
            </button>
        </div>
        
        </div> <!-- End Planner Content -->
        
        <!-- Recipes Tab Content -->
        <div id="recipes-content" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">My Recipe Collection</h2>
                    <button onclick="showAddRecipeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        ➕ Add Recipe
                    </button>
                </div>
                
                <!-- Recipe Search -->
                <div class="mb-4">
                    <input type="text" id="recipe-search" placeholder="Search recipes..." onkeyup="filterRecipes()" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Recipe Grid -->
                <div id="recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Recipes will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Templates Tab Content -->
        <div id="templates-content" class="hidden">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center">Weekly Meal Templates</h2>
                
                <!-- Pre-built Templates -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="built-in-templates">
                    <!-- Templates will be populated here -->
                </div>
                
                <!-- Saved Templates -->
                <div id="saved-templates">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Your Saved Templates</h3>
                    <div id="saved-templates-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- User templates will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Recipe Modal -->
        <div id="add-recipe-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Add New Recipe</h3>
                    <button onclick="hideAddRecipeModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>

                <!-- Import Tabs -->
                <div class="flex mb-4 border-b">
                    <button onclick="showImportTab('manual')" id="manual-tab" class="flex-1 py-2 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        ✏️ Manual Entry
                    </button>
                    <button onclick="showImportTab('url')" id="url-tab" class="flex-1 py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700">
                        🔗 Import from URL
                    </button>
                </div>

                <!-- URL Import Section -->
                <div id="url-import-section" class="hidden">
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">Import Recipe from URL</h4>
                        <p class="text-sm text-blue-700 mb-3">
                            Supported sites: RecipeTin Eats, and other sites with structured recipe data
                        </p>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Recipe URL</label>
                            <input type="url" id="import-url" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="https://www.recipetineats.com/recipe-name/">
                        </div>
                        
                        <button type="button" onclick="importRecipeFromUrl()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            🔍 Extract Recipe
                        </button>
                        
                        <div id="import-status" class="hidden mt-3 p-2 rounded-md">
                            <div id="import-message" class="text-sm"></div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div id="import-preview" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Recipe Preview</h4>
                        <div id="preview-content">
                            <!-- Preview will be populated here -->
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button type="button" onclick="saveImportedRecipe()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                💾 Save Recipe
                            </button>
                            <button type="button" onclick="editImportedRecipe()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm">
                                ✏️ Edit First
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Entry Form -->
                <form id="recipe-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Name</label>
                        <input type="text" id="recipe-name" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Energy Level</label>
                        <select id="recipe-energy" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="high">🚀 High Energy</option>
                            <option value="medium">⚡ Medium Energy</option>
                            <option value="low">😴 Survival Mode</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipment</label>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label><input type="checkbox" value="instant-pot" class="mr-1"> Instant Pot</label>
                            <label><input type="checkbox" value="cast-iron" class="mr-1"> Cast Iron</label>
                            <label><input type="checkbox" value="sous-vide" class="mr-1"> Sous Vide</label>
                            <label><input type="checkbox" value="pizza-oven" class="mr-1"> Pizza Oven</label>
                            <label><input type="checkbox" value="air-fryer" class="mr-1"> Air Fryer</label>
                            <label><input type="checkbox" value="blender" class="mr-1"> Blender</label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cooking Time (minutes)</label>
                        <input type="number" id="recipe-time" min="5" max="300" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ingredients (one per line)</label>
                        <textarea id="recipe-ingredients" rows="6" placeholder="1 lb ground beef&#10;2 tbsp olive oil&#10;1 onion, diced" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
                        <textarea id="recipe-instructions" rows="4" placeholder="Brief cooking instructions..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Icon</label>
                        <div class="grid grid-cols-8 gap-2 text-xl">
                            <button type="button" onclick="selectIcon('🍝')" class="icon-btn p-2 border rounded hover:bg-gray-100">🍝</button>
                            <button type="button" onclick="selectIcon('🥗')" class="icon-btn p-2 border rounded hover:bg-gray-100">🥗</button>
                            <button type="button" onclick="selectIcon('🍖')" class="icon-btn p-2 border rounded hover:bg-gray-100">🍖</button>
                            <button type="button" onclick="selectIcon('🍲')" class="icon-btn p-2 border rounded hover:bg-gray-100">🍲</button>
                            <button type="button" onclick="selectIcon('🍳')" class="icon-btn p-2 border rounded hover:bg-gray-100">🍳</button>
                            <button type="button" onclick="selectIcon('🥘')" class="icon-btn p-2 border rounded hover:bg-gray-100">🥘</button>
                            <button type="button" onclick="selectIcon('🍕')" class="icon-btn p-2 border rounded hover:bg-gray-100">🍕</button>
                            <button type="button" onclick="selectIcon('🥪')" class="icon-btn p-2 border rounded hover:bg-gray-100">🥪</button>
                        </div>
                        <input type="hidden" id="recipe-icon" value="🍽️">
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save Recipe
                        </button>
                        <button type="button" onclick="hideAddRecipeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition duration-200">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recipe Picker Modal -->
        <div id="recipe-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Choose a Recipe</h3>
                    <button onclick="hideRecipePicker()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="recipe-picker-search" placeholder="Search recipes..." onkeyup="filterRecipePicker()" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div id="recipe-picker-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Recipe options will be populated here -->
                </div>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Welcome to Meal Planner</h3>
                    <button onclick="hideAuthModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>

                <!-- Auth Tabs -->
                <div class="flex mb-4 border-b">
                    <button onclick="showAuthTab('login')" id="login-tab" class="flex-1 py-2 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        Login
                    </button>
                    <button onclick="showAuthTab('signup')" id="signup-tab" class="flex-1 py-2 px-4 text-sm font-medium text-gray-500">
                        Sign Up
                    </button>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="auth-form">
                    <form id="login-form-element" onsubmit="handleEmailSignIn(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="login-email" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="login-password" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 mb-3">
                            Login
                        </button>
                    </form>
                    
                    <div class="text-center mb-3">
                        <span class="text-sm text-gray-500">or</span>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="signInWithProvider('google')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continue with Google
                        </button>
                        <button onclick="signInWithProvider('github')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Continue with GitHub
                        </button>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button onclick="showForgotPassword()" class="text-sm text-blue-600 hover:text-blue-800">
                            Forgot password?
                        </button>
                    </div>
                </div>

                <!-- Sign Up Form -->
                <div id="signup-form" class="auth-form hidden">
                    <form id="signup-form-element" onsubmit="handleEmailSignUp(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" id="signup-name" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="signup-email" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="signup-password" required minlength="6" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <div class="text-xs text-gray-500 mt-1">At least 6 characters</div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 mb-3">
                            Create Account
                        </button>
                    </form>
                    
                    <div class="text-center mb-3">
                        <span class="text-sm text-gray-500">or</span>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="signInWithProvider('google')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Sign up with Google
                        </button>
                        <button onclick="signInWithProvider('github')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Sign up with GitHub
                        </button>
                    </div>
                </div>

                <!-- Auth Messages -->
                <div id="auth-message" class="hidden mt-4 p-3 rounded-md">
                    <div id="auth-message-text" class="text-sm"></div>
                </div>
            </div>
        </div>

        <!-- User Menu Dropdown -->
        <div id="user-menu" class="hidden fixed top-16 right-4 bg-white rounded-lg shadow-lg border z-50 min-w-48">
            <div class="py-2">
                <div class="px-4 py-2 border-b">
                    <div class="text-sm font-medium text-gray-900" id="menu-user-name"></div>
                    <div class="text-sm text-gray-500" id="menu-user-email"></div>
                </div>
                <button onclick="showProfileModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    ⚙️ Profile Settings
                </button>
                <button onclick="exportData()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    📤 Export Data
                </button>
                <button onclick="importData()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    📥 Import Data
                </button>
                <div class="border-t">
                    <button onclick="signOut()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                        🚪 Sign Out
                    </button>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">User Profile</h3>
                    <button onclick="hideProfileModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>

                <!-- Profile Header -->
                <div class="flex items-center space-x-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="relative">
                        <img id="profile-avatar" src="" alt="Profile Picture" class="w-16 h-16 rounded-full border-2 border-gray-200 hidden">
                        <div id="profile-avatar-placeholder" class="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-white text-xl font-semibold">
                            ?
                        </div>
                    </div>
                    <div>
                        <h4 id="profile-name" class="text-lg font-semibold text-gray-800"></h4>
                        <p id="profile-email" class="text-sm text-gray-600"></p>
                        <p id="profile-provider" class="text-xs text-gray-500"></p>
                    </div>
                </div>

                <!-- Profile Form -->
                <form id="profile-form" onsubmit="saveProfile(event)">
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" id="profile-display-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Avatar URL (Optional)</label>
                            <input type="url" id="profile-avatar-url" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="https://...">
                        </div>
                    </div>

                    <!-- Cooking Equipment -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cooking Equipment</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="Instant Pot" class="equipment-checkbox mr-2">
                                <span class="text-sm">Instant Pot</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Cast Iron" class="equipment-checkbox mr-2">
                                <span class="text-sm">Cast Iron</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Stand Mixer" class="equipment-checkbox mr-2">
                                <span class="text-sm">Stand Mixer</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Sous Vide" class="equipment-checkbox mr-2">
                                <span class="text-sm">Sous Vide</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Pizza Oven" class="equipment-checkbox mr-2">
                                <span class="text-sm">Pizza Oven</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Mandoline" class="equipment-checkbox mr-2">
                                <span class="text-sm">Mandoline</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Nutribullet" class="equipment-checkbox mr-2">
                                <span class="text-sm">Nutribullet</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Air Fryer" class="equipment-checkbox mr-2">
                                <span class="text-sm">Air Fryer</span>
                            </label>
                        </div>
                    </div>

                    <!-- Dietary Restrictions -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dietary Restrictions</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="Vegetarian" class="dietary-checkbox mr-2">
                                <span class="text-sm">Vegetarian</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Vegan" class="dietary-checkbox mr-2">
                                <span class="text-sm">Vegan</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Gluten-Free" class="dietary-checkbox mr-2">
                                <span class="text-sm">Gluten-Free</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Dairy-Free" class="dietary-checkbox mr-2">
                                <span class="text-sm">Dairy-Free</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Keto" class="dietary-checkbox mr-2">
                                <span class="text-sm">Keto</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="Low-Carb" class="dietary-checkbox mr-2">
                                <span class="text-sm">Low-Carb</span>
                            </label>
                        </div>
                    </div>

                    <!-- Password Change Section (for email users) -->
                    <div id="password-section" class="mb-6 hidden">
                        <h5 class="text-lg font-medium text-gray-800 mb-3">Change Password</h5>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" id="new-password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" minlength="6">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                                <input type="password" id="confirm-password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" minlength="6">
                            </div>
                        </div>
                        <button type="button" onclick="changePassword()" class="mt-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md text-sm">
                            Update Password
                        </button>
                    </div>

                    <!-- OAuth Connection Info -->
                    <div id="oauth-section" class="mb-6 hidden">
                        <h5 class="text-lg font-medium text-gray-800 mb-3">OAuth Connection</h5>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                            <div class="flex items-center space-x-2">
                                <div id="oauth-provider-icon"></div>
                                <div>
                                    <p class="text-sm font-medium" id="oauth-provider-text"></p>
                                    <p class="text-xs text-gray-600">Connected via OAuth</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Actions -->
                    <div class="flex flex-wrap gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save Changes
                        </button>
                        <button type="button" onclick="migrateLocalData()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                            Migrate Local Data
                        </button>
                        <button type="button" onclick="signOut()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm">
                            Sign Out
                        </button>
                    </div>
                </form>

                <!-- Success/Error Messages -->
                <div id="profile-success" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-md">
                    <div class="text-green-800 text-sm">✅ Profile updated successfully!</div>
                </div>
                <div id="profile-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
                    <div class="text-red-800 text-sm">❌ <span id="profile-error-message">Failed to update profile.</span></div>
                </div>
            </div>
        </div>

        <!-- Floating Bug Report Button -->
        <div class="fixed bottom-6 right-6 z-40">
            <button onclick="showBugReportModal()" title="Report bugs, request features, or give feedback" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2 group hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span class="hidden md:inline-block text-sm">Report Bug</span>
                <span class="md:hidden text-xs">Report</span>
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let currentTextarea = null;
        let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
        let savedTemplates = JSON.parse(localStorage.getItem('savedTemplates')) || [];
        
        // Energy-based meal suggestions tailored to your lifestyle
        const mealSuggestions = {
            high: {
                title: "High Energy - Time to Cook! 🚀",
                meals: [
                    "🍖 Instant Pot Lamb Ragu (batch cook for freezing)",
                    "🍕 Homemade pizza with your benchtop oven",
                    "🥩 Sous vide steak with elaborate sides",
                    "🍛 Complex curry using your 48-spice collection",
                    "🍝 Fresh pasta from scratch with stand mixer",
                    "🐟 Pan-seared fish with roasted vegetables",
                    "🍲 Cast iron braised short ribs",
                    "🥘 Moroccan tagine with preserved lemons"
                ]
            },
            medium: {
                title: "Medium Energy - Solid Cooking ⚡",
                meals: [
                    "🍳 Quick stir-fry with whatever vegetables you have",
                    "🍝 One-pot pasta with herbs from your spice collection",
                    "🍛 Simple curry using pre-made spice blends",
                    "🍗 Cast iron chicken thighs with minimal prep",
                    "🌯 Good wraps with quality fillings",
                    "🍜 Upgraded instant ramen with proper toppings",
                    "🥗 Mandoline-sliced salad with protein",
                    "🍳 Fancy scrambled eggs with herbs"
                ]
            },
            low: {
                title: "Survival Mode - Avoid Uber Eats! 😴",
                meals: [
                    "🍞 Fancy toast (good bread + simple toppings)",
                    "🥗 Pre-made salad with protein you have on hand",
                    "🍝 Pasta with quality jarred sauce + cheese",
                    "🥪 Upgraded sandwiches with good ingredients",
                    "🍲 Heat up frozen Dinner Ladies meal",
                    "🥤 Nutribullet smoothie bowl with nuts/seeds",
                    "🧀 Cheese and crackers with fruit",
                    "🥣 Good cereal or overnight oats"
                ]
            }
        };

        // Built-in templates
        const builtInTemplates = [
            {
                name: "High Energy Week",
                description: "For when you're motivated to cook complex meals",
                meals: {
                    Monday: { Breakfast: "🥣 Overnight oats with fruit", Lunch: "🥗 Grain bowl with protein", Dinner: "🍖 Instant Pot Lamb Ragu" },
                    Tuesday: { Breakfast: "🍳 Veggie scramble", Lunch: "🌯 Leftover ragu wrap", Dinner: "🍕 Homemade pizza" },
                    Wednesday: { Breakfast: "🥤 Green smoothie", Lunch: "🍕 Pizza leftovers", Dinner: "🥩 Sous vide steak" },
                    Thursday: { Breakfast: "🍞 Avocado toast", Lunch: "🥗 Steak salad", Dinner: "🍛 Complex curry" },
                    Friday: { Breakfast: "🥣 Yogurt parfait", Lunch: "🍛 Curry leftovers", "Pre-Bar Dinner": "🍳 Quick pasta" },
                    Saturday: { "Late Breakfast": "🥞 Weekend pancakes", Lunch: "🥪 Deli sandwich", "Pre-Bar Dinner": "🥘 Moroccan tagine" },
                    Sunday: { "Late Breakfast": "🍳 Big breakfast", Lunch: "🥘 Tagine leftovers", Dinner: "🍲 Cast iron short ribs" }
                }
            },
            {
                name: "Survival Mode Week", 
                description: "Low energy, anti-takeaway options",
                meals: {
                    Monday: { Breakfast: "🥣 Good cereal", Lunch: "🥪 Quality sandwich", Dinner: "🍝 Pasta with jarred sauce" },
                    Tuesday: { Breakfast: "🍞 Fancy toast", Lunch: "🥗 Pre-made salad", Dinner: "🍲 Dinner Ladies meal" },
                    Wednesday: { Breakfast: "🥤 Smoothie", Lunch: "🍝 Pasta leftovers", Dinner: "🧀 Cheese and crackers" },
                    Thursday: { Breakfast: "🥣 Overnight oats", Lunch: "🥪 Another sandwich", Dinner: "🥗 Salad with protein" },
                    Friday: { Breakfast: "🍞 Toast", Lunch: "🥤 Smoothie bowl", "Pre-Bar Dinner": "🍝 Quick pasta" },
                    Saturday: { "Late Breakfast": "🥣 Recovery cereal", Lunch: "🥪 Easy wrap", "Pre-Bar Dinner": "🍲 Microwave meal" },
                    Sunday: { "Late Breakfast": "🍞 Comfort toast", Lunch: "🧀 Cheese board", Dinner: "🥗 Simple salad" }
                }
            }
        ];

        // Tab switching
        function switchTab(tabName) {
            // Hide all content
            document.getElementById('planner-content').classList.add('hidden');
            document.getElementById('recipes-content').classList.add('hidden');
            document.getElementById('templates-content').classList.add('hidden');
            
            // Show selected content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
            
            document.getElementById('tab-' + tabName).classList.add('bg-blue-500', 'text-white');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-700', 'hover:bg-gray-100');
            
            // Load content if needed
            if (tabName === 'recipes') {
                loadRecipes();
            } else if (tabName === 'templates') {
                loadTemplates();
            }
        }

        function setEnergyLevel(level) {
            // Update button states
            document.querySelectorAll('[id^="energy-"]').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
                if (btn.id === `energy-${level}`) {
                    btn.classList.add('ring-2', 'ring-offset-2', level === 'high' ? 'ring-green-500' : level === 'medium' ? 'ring-yellow-500' : 'ring-red-500');
                }
            });

            // Show suggestions
            const panel = document.getElementById('suggestions-panel');
            const content = document.getElementById('suggestions-content');
            const suggestions = mealSuggestions[level];
            
            content.innerHTML = `
                <div class="font-medium mb-2">${suggestions.title}</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    ${suggestions.meals.map(meal => `<div class="cursor-pointer hover:bg-blue-100 p-2 rounded transition-colors" onclick="quickAddMeal('${meal.replace(/'/g, "\\\\'")}')">&bull; ${meal}</div>`).join('')}
                </div>
                <div class="mt-3 text-xs text-blue-600">💡 Click any meal to quickly add it to your planner</div>
            `;
            
            panel.classList.remove('hidden');
        }

        function quickAddMeal(meal) {
            // Find the first empty textarea and add the meal
            const textareas = document.querySelectorAll('#planner-content textarea');
            for (let textarea of textareas) {
                if (!textarea.value.trim()) {
                    textarea.value = meal;
                    textarea.focus();
                    break;
                }
            }
        }

        // Recipe management
        function showAddRecipeModal() {
            document.getElementById('add-recipe-modal').classList.remove('hidden');
        }

        function hideAddRecipeModal() {
            document.getElementById('add-recipe-modal').classList.add('hidden');
            document.getElementById('recipe-form').reset();
        }

        function selectIcon(icon) {
            document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('recipe-icon').value = icon;
        }

        document.getElementById('recipe-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const equipment = Array.from(document.querySelectorAll('#add-recipe-modal input[type="checkbox"]:checked')).map(cb => cb.value);
            
            const recipe = {
                id: Date.now(),
                name: document.getElementById('recipe-name').value,
                energy: document.getElementById('recipe-energy').value,
                equipment: equipment,
                time: document.getElementById('recipe-time').value,
                ingredients: document.getElementById('recipe-ingredients').value.split('\n').filter(i => i.trim()),
                instructions: document.getElementById('recipe-instructions').value,
                icon: document.getElementById('recipe-icon').value || '🍽️'
            };
            
            recipes.push(recipe);
            localStorage.setItem('recipes', JSON.stringify(recipes));
            loadRecipes();
            hideAddRecipeModal();
        });

        function loadRecipes() {
            const grid = document.getElementById('recipes-grid');
            if (recipes.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No recipes yet. Add your first recipe!</div>';
                return;
            }
            
            grid.innerHTML = recipes.map(recipe => `
                <div class="bg-white rounded-lg shadow-md p-4 border hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-2xl">${recipe.icon}</div>
                        <div class="flex gap-1">
                            <button onclick="useRecipe('${recipe.name}')" class="text-blue-500 hover:text-blue-700 text-sm">Use</button>
                            <button onclick="deleteRecipe(${recipe.id})" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </div>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-1">${recipe.name}</h3>
                    <div class="text-xs text-gray-600 mb-2">
                        ${recipe.energy === 'high' ? '🚀 High Energy' : recipe.energy === 'medium' ? '⚡ Medium Energy' : '😴 Survival Mode'}
                        ${recipe.time ? ` • ${recipe.time} min` : ''}
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        ${recipe.equipment.length > 0 ? recipe.equipment.join(', ') : 'No special equipment'}
                    </div>
                    <div class="text-sm text-gray-700 mb-2">
                        <strong>Ingredients:</strong> ${recipe.ingredients.slice(0, 3).join(', ')}${recipe.ingredients.length > 3 ? '...' : ''}
                    </div>
                    ${recipe.instructions ? `<div class="text-sm text-gray-600">${recipe.instructions.substring(0, 100)}${recipe.instructions.length > 100 ? '...' : ''}</div>` : ''}
                </div>
            `).join('');
        }

        function filterRecipes() {
            const search = document.getElementById('recipe-search').value.toLowerCase();
            const filteredRecipes = recipes.filter(recipe => 
                recipe.name.toLowerCase().includes(search) ||
                recipe.ingredients.some(ing => ing.toLowerCase().includes(search))
            );
            
            const grid = document.getElementById('recipes-grid');
            grid.innerHTML = filteredRecipes.map(recipe => `
                <div class="bg-white rounded-lg shadow-md p-4 border hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-2xl">${recipe.icon}</div>
                        <div class="flex gap-1">
                            <button onclick="useRecipe('${recipe.name}')" class="text-blue-500 hover:text-blue-700 text-sm">Use</button>
                            <button onclick="deleteRecipe(${recipe.id})" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </div>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-1">${recipe.name}</h3>
                    <div class="text-xs text-gray-600 mb-2">
                        ${recipe.energy === 'high' ? '🚀 High Energy' : recipe.energy === 'medium' ? '⚡ Medium Energy' : '😴 Survival Mode'}
                        ${recipe.time ? ` • ${recipe.time} min` : ''}
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        ${recipe.equipment.length > 0 ? recipe.equipment.join(', ') : 'No special equipment'}
                    </div>
                    <div class="text-sm text-gray-700 mb-2">
                        <strong>Ingredients:</strong> ${recipe.ingredients.slice(0, 3).join(', ')}${recipe.ingredients.length > 3 ? '...' : ''}
                    </div>
                    ${recipe.instructions ? `<div class="text-sm text-gray-600">${recipe.instructions.substring(0, 100)}${recipe.instructions.length > 100 ? '...' : ''}</div>` : ''}
                </div>
            `).join('');
        }

        function deleteRecipe(id) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                recipes = recipes.filter(r => r.id !== id);
                localStorage.setItem('recipes', JSON.stringify(recipes));
                loadRecipes();
            }
        }

        function useRecipe(recipeName) {
            const textareas = document.querySelectorAll('#planner-content textarea');
            for (let textarea of textareas) {
                if (!textarea.value.trim()) {
                    textarea.value = recipeName;
                    textarea.focus();
                    switchTab('planner');
                    break;
                }
            }
        }

        // Recipe picker
        function showRecipePicker(button) {
            currentTextarea = button.parentElement.querySelector('textarea');
            document.getElementById('recipe-picker-modal').classList.remove('hidden');
            loadRecipePicker();
        }

        function hideRecipePicker() {
            document.getElementById('recipe-picker-modal').classList.add('hidden');
            currentTextarea = null;
        }

        function loadRecipePicker() {
            const grid = document.getElementById('recipe-picker-grid');
            const allOptions = [...recipes.map(r => ({ name: r.name, icon: r.icon, type: 'recipe' }))];
            
            // Add energy-based suggestions
            Object.entries(mealSuggestions).forEach(([energy, data]) => {
                data.meals.forEach(meal => {
                    allOptions.push({ name: meal, icon: '💡', type: 'suggestion' });
                });
            });
            
            grid.innerHTML = allOptions.map(option => `
                <div class="bg-gray-50 hover:bg-blue-50 p-3 rounded-lg cursor-pointer border transition-colors" 
                     onclick="selectRecipeOption('${option.name.replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${option.icon}</span>
                        <span class="text-sm">${option.name}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectRecipeOption(name) {
            if (currentTextarea) {
                currentTextarea.value = name;
                hideRecipePicker();
            }
        }

        function filterRecipePicker() {
            const search = document.getElementById('recipe-picker-search').value.toLowerCase();
            const options = document.querySelectorAll('#recipe-picker-grid > div');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(search)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Templates
        function loadTemplates() {
            const builtInGrid = document.getElementById('built-in-templates');
            builtInGrid.innerHTML = builtInTemplates.map(template => `
                <div class="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                    <h3 class="font-semibold text-gray-800 mb-2">${template.name}</h3>
                    <p class="text-sm text-gray-600 mb-4">${template.description}</p>
                    <button onclick="loadTemplate('${template.name}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Load Template
                    </button>
                </div>
            `).join('');
            
            const savedGrid = document.getElementById('saved-templates-grid');
            if (savedTemplates.length === 0) {
                savedGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No saved templates yet.</div>';
            } else {
                savedGrid.innerHTML = savedTemplates.map(template => `
                    <div class="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                        <h3 class="font-semibold text-gray-800 mb-2">${template.name}</h3>
                        <p class="text-sm text-gray-600 mb-4">Saved on ${new Date(template.created).toLocaleDateString()}</p>
                        <div class="flex gap-2">
                            <button onclick="loadUserTemplate(${template.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Load
                            </button>
                            <button onclick="deleteTemplate(${template.id})" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadTemplate(templateName) {
            const template = builtInTemplates.find(t => t.name === templateName);
            if (template) {
                const textareas = document.querySelectorAll('#planner-content textarea');
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                days.forEach((day, dayIndex) => {
                    meals.forEach((meal, mealIndex) => {
                        const textareaIndex = dayIndex * 3 + mealIndex;
                        const mealKey = Object.keys(template.meals[day])[mealIndex];
                        if (template.meals[day] && template.meals[day][mealKey]) {
                            textareas[textareaIndex].value = template.meals[day][mealKey];
                        }
                    });
                });
                
                switchTab('planner');
                alert('Template loaded successfully!');
            }
        }

        function saveAsTemplate() {
            const name = prompt('Enter a name for this template:');
            if (!name) return;
            
            const textareas = document.querySelectorAll('#planner-content textarea');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const meals = ['Breakfast', 'Lunch', 'Dinner'];
            const templateMeals = {};
            
            days.forEach((day, dayIndex) => {
                templateMeals[day] = {};
                meals.forEach((meal, mealIndex) => {
                    const textareaIndex = dayIndex * 3 + mealIndex;
                    const value = textareas[textareaIndex].value.trim();
                    if (value) {
                        templateMeals[day][meal] = value;
                    }
                });
            });
            
            const template = {
                id: Date.now(),
                name: name,
                meals: templateMeals,
                created: Date.now()
            };
            
            savedTemplates.push(template);
            localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
            alert('Template saved successfully!');
        }

        function loadUserTemplate(id) {
            const template = savedTemplates.find(t => t.id === id);
            if (template) {
                const textareas = document.querySelectorAll('#planner-content textarea');
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                // Clear all textareas first
                textareas.forEach(textarea => textarea.value = '');
                
                days.forEach((day, dayIndex) => {
                    if (template.meals[day]) {
                        Object.entries(template.meals[day]).forEach(([meal, value], mealIndex) => {
                            const textareaIndex = dayIndex * 3 + mealIndex;
                            if (textareas[textareaIndex]) {
                                textareas[textareaIndex].value = value;
                            }
                        });
                    }
                });
                
                switchTab('planner');
                alert('Template loaded successfully!');
            }
        }

        function deleteTemplate(id) {
            if (confirm('Are you sure you want to delete this template?')) {
                savedTemplates = savedTemplates.filter(t => t.id !== id);
                localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
                loadTemplates();
            }
        }

        function generateGroceryList() {
            const textareas = document.querySelectorAll('#planner-content textarea');
            const meals = [];
            
            textareas.forEach(textarea => {
                if (textarea.value.trim()) {
                    meals.push(textarea.value.trim());
                }
            });
            
            if (meals.length === 0) {
                alert('Add some meals to your planner first!');
                return;
            }
            
            // Create a simple grocery list popup
            const groceryWindow = window.open('', 'GroceryList', 'width=600,height=800,scrollbars=yes');
            groceryWindow.document.write(`
                <html>
                <head>
                    <title>Grocery List</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                        .meal { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; }
                        .note { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #ffc107; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>🛒 Grocery List</h1>
                    <div class="note">
                        <strong>📝 Note:</strong> This is a basic list based on your meals. Check your pantry, spice drawer, and fridge first!
                    </div>
                    <h2>Planned Meals:</h2>
                    ${meals.map(meal => `<div class="meal">&bull; ${meal}</div>`).join('')}
                    
                    <h2>Shopping Categories:</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <h3>🥩 Proteins</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add proteins needed for your meals</em>
                            </div>
                        </div>
                        <div>
                            <h3>🥬 Fresh Produce</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add vegetables and herbs (check your spice drawer first!)</em>
                            </div>
                        </div>
                        <div>
                            <h3>🥫 Pantry</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add pantry staples</em>
                            </div>
                        </div>
                        <div>
                            <h3>❄️ Frozen</h3>
                            <div style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                                <em>Add frozen items (maybe backup Dinner Ladies meals?)</em>
                            </div>
                        </div>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px;">
                        <button onclick="window.print()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">🖨️ Print List</button>
                        <button onclick="window.close()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
        }

        function saveMealPlan() {
            const textareas = document.querySelectorAll('#planner-content textarea');
            const mealPlan = {};
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const meals = ['Breakfast', 'Lunch', 'Dinner'];
            
            days.forEach((day, dayIndex) => {
                mealPlan[day] = {};
                meals.forEach((meal, mealIndex) => {
                    const textareaIndex = dayIndex * 3 + mealIndex;
                    mealPlan[day][meal] = textareas[textareaIndex].value;
                });
            });
            
            localStorage.setItem('mealPlan', JSON.stringify(mealPlan));
            alert('Meal plan saved!');
        }

        function clearMealPlan() {
            if (confirm('Are you sure you want to clear all meals?')) {
                document.querySelectorAll('#planner-content textarea').forEach(textarea => {
                    textarea.value = '';
                });
                localStorage.removeItem('mealPlan');
            }
        }

        function loadMealPlan() {
            const savedPlan = localStorage.getItem('mealPlan');
            if (savedPlan) {
                const mealPlan = JSON.parse(savedPlan);
                const textareas = document.querySelectorAll('#planner-content textarea');
                
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                days.forEach((day, dayIndex) => {
                    if (mealPlan[day]) {
                        meals.forEach((meal, mealIndex) => {
                            const textareaIndex = dayIndex * 3 + mealIndex;
                            if (mealPlan[day][meal]) {
                                textareas[textareaIndex].value = mealPlan[day][meal];
                            }
                        });
                    }
                });
            }
        }

        // Load saved meal plan when page loads
        window.addEventListener('load', loadMealPlan);
        
        // Auto-suggest energy level based on time and day (based on your schedule)
        window.addEventListener('load', function() {
            const now = new Date();
            const day = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const hour = now.getHours();
            
            // Auto-suggest energy level based on your schedule
            let suggestedEnergy = 'medium';
            
            // Tuesday (WFH day) - suggest high energy
            if (day === 2) {
                suggestedEnergy = 'high';
            }
            // Friday evening (before bar work) or very late/early hours
            else if ((day === 5 && hour >= 17) || hour < 6 || hour > 23) {
                suggestedEnergy = 'low';
            }
            // Weekend mornings (after bar work)
            else if ((day === 6 || day === 0) && hour < 12) {
                suggestedEnergy = 'low';
            }
            
            // Highlight the suggested energy level
            const suggestedBtn = document.getElementById(`energy-${suggestedEnergy}`);
            if (suggestedBtn) {
                suggestedBtn.style.boxShadow = '0 0 0 2px #3b82f6';
                suggestedBtn.style.animation = 'pulse 2s infinite';
            }
        });

        // ===== Authentication Functions =====
        
        function showAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                modal.classList.remove('hidden');
                showAuthTab('login');
            }
        }

        function hideAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            if (tab === 'login') {
                loginTab.classList.add('bg-blue-500', 'text-white');
                loginTab.classList.remove('text-gray-700', 'hover:bg-gray-100');
                signupTab.classList.remove('bg-blue-500', 'text-white');
                signupTab.classList.add('text-gray-700', 'hover:bg-gray-100');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                signupTab.classList.add('bg-blue-500', 'text-white');
                signupTab.classList.remove('text-gray-700', 'hover:bg-gray-100');
                loginTab.classList.remove('bg-blue-500', 'text-white');
                loginTab.classList.add('text-gray-700', 'hover:bg-gray-100');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        async function signInWithProvider(provider) {
            try {
                const result = await window.mealPlannerAPI.signInWithProvider(provider);
                console.log('OAuth sign in initiated:', result);
                hideAuthModal();
            } catch (error) {
                console.error('OAuth sign in failed:', error);
                alert('Sign in failed. Please check your internet connection and try again.');
            }
        }

        async function handleEmailSignIn(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const result = await window.mealPlannerAPI.signIn(email, password);
                console.log('Email sign in successful:', result);
                hideAuthModal();
            } catch (error) {
                console.error('Email sign in failed:', error);
                alert('Sign in failed: ' + error.message);
            }
        }

        async function handleEmailSignUp(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const displayName = document.getElementById('signup-name').value;

            try {
                const result = await window.mealPlannerAPI.signUp(email, password, {
                    display_name: displayName
                });
                console.log('Email sign up successful:', result);
                hideAuthModal();
                alert('Account created! Please check your email to verify your account.');
            } catch (error) {
                console.error('Email sign up failed:', error);
                alert('Sign up failed: ' + error.message);
            }
        }

        function showUserMenu() {
            const userMenu = document.getElementById('user-menu');
            const user = window.mealPlannerAPI.getCurrentUser();
            
            if (user && userMenu) {
                // Update menu with current user info
                document.getElementById('menu-user-name').textContent = user.user_metadata?.display_name || user.email;
                document.getElementById('menu-user-email').textContent = user.email;
                
                // Toggle menu visibility
                userMenu.classList.toggle('hidden');
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!userMenu.contains(e.target) && !e.target.closest('#user-info')) {
                            userMenu.classList.add('hidden');
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }
        }

        function showProfileModal() {
            const modal = document.getElementById('profile-modal');
            const user = window.mealPlannerAPI.getCurrentUser();
            
            if (user && modal) {
                loadUserProfile(user);
                modal.classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
            }
        }

        function hideProfileModal() {
            const modal = document.getElementById('profile-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function loadUserProfile(user) {
            try {
                // Load user profile data
                const profile = await window.mealPlannerAPI.getUserProfile() || {};
                
                // Basic user info
                document.getElementById('profile-name').textContent = user.user_metadata?.display_name || user.email;
                document.getElementById('profile-email').textContent = user.email;
                
                // Avatar
                const avatar = document.getElementById('profile-avatar');
                const placeholder = document.getElementById('profile-avatar-placeholder');
                if (user.user_metadata?.avatar_url) {
                    avatar.src = user.user_metadata.avatar_url;
                    avatar.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                } else {
                    avatar.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                    placeholder.textContent = (user.user_metadata?.display_name || user.email).charAt(0).toUpperCase();
                }
                
                // Provider info
                const provider = user.app_metadata?.provider || 'email';
                document.getElementById('profile-provider').textContent = `Signed in via ${provider}`;
                
                // Form fields
                document.getElementById('profile-display-name').value = user.user_metadata?.display_name || '';
                document.getElementById('profile-avatar-url').value = profile.avatar_url || '';
                
                // Equipment checkboxes
                const equipment = profile.cooking_equipment || [];
                document.querySelectorAll('.equipment-checkbox').forEach(cb => {
                    cb.checked = equipment.includes(cb.value);
                });
                
                // Dietary restrictions
                const dietary = profile.dietary_restrictions || [];
                document.querySelectorAll('.dietary-checkbox').forEach(cb => {
                    cb.checked = dietary.includes(cb.value);
                });
                
                // Show/hide sections based on provider
                const passwordSection = document.getElementById('password-section');
                const oauthSection = document.getElementById('oauth-section');
                
                if (provider === 'email') {
                    passwordSection.classList.remove('hidden');
                    oauthSection.classList.add('hidden');
                } else {
                    passwordSection.classList.add('hidden');
                    oauthSection.classList.remove('hidden');
                    
                    // OAuth provider info
                    const providerIcon = document.getElementById('oauth-provider-icon');
                    const providerText = document.getElementById('oauth-provider-text');
                    
                    if (provider === 'google') {
                        providerIcon.innerHTML = '🔍';
                        providerText.textContent = 'Google Account';
                    } else if (provider === 'github') {
                        providerIcon.innerHTML = '🐙';
                        providerText.textContent = 'GitHub Account';
                    }
                }
                
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            
            const successDiv = document.getElementById('profile-success');
            const errorDiv = document.getElementById('profile-error');
            const errorMessage = document.getElementById('profile-error-message');
            
            // Reset messages
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            
            try {
                // Collect equipment
                const equipment = Array.from(document.querySelectorAll('.equipment-checkbox:checked'))
                    .map(cb => cb.value);
                
                // Collect dietary restrictions
                const dietary = Array.from(document.querySelectorAll('.dietary-checkbox:checked'))
                    .map(cb => cb.value);
                
                // Prepare profile data
                const profileData = {
                    display_name: document.getElementById('profile-display-name').value,
                    avatar_url: document.getElementById('profile-avatar-url').value,
                    cooking_equipment: equipment,
                    dietary_restrictions: dietary
                };
                
                // Save to Supabase
                await window.mealPlannerAPI.updateUserProfile(profileData);
                
                // Show success message
                successDiv.classList.remove('hidden');
                
                // Update UI
                updateAuthUI(window.mealPlannerAPI.getCurrentUser());
                
            } catch (error) {
                console.error('Error saving profile:', error);
                errorMessage.textContent = error.message || 'Failed to save profile';
                errorDiv.classList.remove('hidden');
            }
        }

        async function changePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('profile-error');
            const errorMessage = document.getElementById('profile-error-message');
            const successDiv = document.getElementById('profile-success');
            
            if (!newPassword || newPassword.length < 6) {
                errorMessage.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Note: Supabase doesn't have updatePassword - user needs to reset via email
                errorMessage.textContent = 'Password changes require email verification. Please use "Forgot Password" in the login form.';
                errorDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error changing password:', error);
                errorMessage.textContent = error.message || 'Failed to change password';
                errorDiv.classList.remove('hidden');
            }
        }

        function exportData() {
            // Close menu
            document.getElementById('user-menu').classList.add('hidden');
            
            // Export user data
            const data = {
                recipes: JSON.parse(localStorage.getItem('recipes')) || [],
                mealPlan: JSON.parse(localStorage.getItem('mealPlan')) || {},
                templates: JSON.parse(localStorage.getItem('savedTemplates')) || []
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meal-planner-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            // Close menu
            document.getElementById('user-menu').classList.add('hidden');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (data.recipes) localStorage.setItem('recipes', JSON.stringify(data.recipes));
                            if (data.mealPlan) localStorage.setItem('mealPlan', JSON.stringify(data.mealPlan));
                            if (data.templates) localStorage.setItem('savedTemplates', JSON.stringify(data.templates));
                            
                            alert('Data imported successfully! Please refresh the page.');
                        } catch (error) {
                            alert('Invalid file format. Please select a valid JSON export file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        async function signOut() {
            try {
                await window.mealPlannerAPI.signOut();
                console.log('Signed out successfully');
            } catch (error) {
                console.error('Sign out failed:', error);
            }
        }

        async function migrateLocalData() {
            try {
                await window.mealPlannerAPI.migrateLocalStorageToSupabase();
                alert('Local data migrated successfully! Your recipes and meal plans are now saved to your account.');
                location.reload(); // Refresh to load cloud data
            } catch (error) {
                console.error('Migration failed:', error);
                alert('Migration failed: ' + error.message);
            }
        }

        // Listen for auth state changes
        window.addEventListener('authStateChange', (event) => {
            const { user } = event.detail;
            updateAuthUI(user);
        });

        function updateAuthUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const userAvatar = document.getElementById('user-avatar');

            if (user) {
                // User is signed in
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                
                userName.textContent = user.user_metadata?.display_name || user.email;
                
                if (user.user_metadata?.avatar_url) {
                    userAvatar.src = user.user_metadata.avatar_url;
                    userAvatar.classList.remove('hidden');
                } else {
                    userAvatar.classList.add('hidden');
                }
            } else {
                // User is signed out
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
            }
        }

        function showForgotPassword() {
            const email = prompt('Enter your email address for password reset:');
            if (email) {
                window.mealPlannerAPI.resetPassword(email)
                    .then(() => {
                        alert('Password reset email sent! Please check your inbox.');
                    })
                    .catch((error) => {
                        console.error('Password reset failed:', error);
                        alert('Password reset failed: ' + error.message);
                    });
            }
        }

        // Bug report functions (ensure they're available globally)
        function showBugReportModal() {
            if (window.bugReportSystem) {
                window.bugReportSystem.showBugReportModal();
            } else {
                console.error('Bug report system not loaded');
                alert('Bug reporting system is loading. Please try again in a moment.');
            }
        }

        function closeBugReportModal() {
            if (window.bugReportSystem) {
                window.bugReportSystem.closeBugReportModal();
            }
        }

        // Make functions globally available
        window.showBugReportModal = showBugReportModal;
        window.closeBugReportModal = closeBugReportModal;

        // Recipe Import Functions
        let importedRecipeData = null;

        function showImportTab(tab) {
            const manualTab = document.getElementById('manual-tab');
            const urlTab = document.getElementById('url-tab');
            const urlSection = document.getElementById('url-import-section');
            const manualForm = document.getElementById('recipe-form');

            if (tab === 'url') {
                // Switch to URL import
                urlTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                urlTab.classList.remove('text-gray-500', 'hover:text-gray-700');
                manualTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                manualTab.classList.add('text-gray-500', 'hover:text-gray-700');
                
                urlSection.classList.remove('hidden');
                manualForm.classList.add('hidden');
            } else {
                // Switch to manual entry
                manualTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                manualTab.classList.remove('text-gray-500', 'hover:text-gray-700');
                urlTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                urlTab.classList.add('text-gray-500', 'hover:text-gray-700');
                
                urlSection.classList.add('hidden');
                manualForm.classList.remove('hidden');
            }
        }

        async function importRecipeFromUrl() {
            const url = document.getElementById('import-url').value;
            const statusDiv = document.getElementById('import-status');
            const messageDiv = document.getElementById('import-message');
            const previewDiv = document.getElementById('import-preview');

            if (!url) {
                showImportStatus('Please enter a recipe URL', 'error');
                return;
            }

            // Validate URL
            if (!isValidRecipeUrl(url)) {
                showImportStatus('Please enter a valid recipe URL from a supported site', 'error');
                return;
            }

            showImportStatus('Extracting recipe data...', 'loading');

            try {
                const recipeData = await extractRecipeFromUrl(url);
                if (recipeData) {
                    importedRecipeData = recipeData;
                    showRecipePreview(recipeData);
                    showImportStatus('Recipe extracted successfully!', 'success');
                    previewDiv.classList.remove('hidden');
                } else {
                    showImportStatus('Could not extract recipe data from this URL', 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showImportStatus('Failed to import recipe: ' + error.message, 'error');
            }
        }

        function isValidRecipeUrl(url) {
            const supportedDomains = [
                'recipetineats.com',
                'www.recipetineats.com'
            ];
            
            try {
                const urlObj = new URL(url);
                return supportedDomains.some(domain => urlObj.hostname === domain);
            } catch {
                return false;
            }
        }

        async function extractRecipeFromUrl(url) {
            // Since we can't directly fetch from other domains due to CORS,
            // we'll use a CORS proxy service for demonstration
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            
            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const htmlContent = data.contents;
                
                // Parse the HTML to extract JSON-LD recipe data
                return parseRecipeFromHtml(htmlContent);
            } catch (error) {
                console.error('Fetch error:', error);
                throw new Error('Unable to fetch recipe data');
            }
        }

        function parseRecipeFromHtml(html) {
            // Create a temporary DOM element to parse the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Look for JSON-LD script tags
            const jsonLdScripts = doc.querySelectorAll('script[type="application/ld+json"]');
            
            for (const script of jsonLdScripts) {
                try {
                    const data = JSON.parse(script.textContent);
                    
                    // Handle different JSON-LD structures
                    let recipe = null;
                    
                    if (data['@type'] === 'Recipe') {
                        recipe = data;
                    } else if (data['@graph']) {
                        recipe = data['@graph'].find(item => item['@type'] === 'Recipe');
                    } else if (Array.isArray(data)) {
                        recipe = data.find(item => item['@type'] === 'Recipe');
                    }
                    
                    if (recipe) {
                        return formatRecipeData(recipe);
                    }
                } catch (e) {
                    console.log('Failed to parse JSON-LD script:', e);
                }
            }
            
            return null;
        }

        function formatRecipeData(recipeJson) {
            const recipe = {
                title: recipeJson.name || '',
                description: recipeJson.description || '',
                ingredients: [],
                instructions: recipeJson.recipeInstructions || [],
                cookingTime: extractTime(recipeJson.cookTime) || extractTime(recipeJson.totalTime) || 30,
                energyLevel: 'medium',
                equipment: extractEquipment(recipeJson),
                icon: '🍽️',
                servings: recipeJson.recipeYield || '',
                prepTime: extractTime(recipeJson.prepTime) || '',
                source: recipeJson.url || ''
            };

            // Format ingredients
            if (recipeJson.recipeIngredient) {
                recipe.ingredients = recipeJson.recipeIngredient.map(ingredient => 
                    typeof ingredient === 'string' ? ingredient : ingredient.name || ingredient
                );
            }

            // Format instructions
            if (recipeJson.recipeInstructions) {
                recipe.instructions = formatInstructions(recipeJson.recipeInstructions);
            }

            return recipe;
        }

        function extractTime(timeStr) {
            if (!timeStr) return null;
            
            // Handle ISO 8601 duration format (PT15M = 15 minutes)
            const isoMatch = timeStr.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
            if (isoMatch) {
                const hours = parseInt(isoMatch[1] || 0);
                const minutes = parseInt(isoMatch[2] || 0);
                return hours * 60 + minutes;
            }
            
            // Handle simple number
            const numMatch = timeStr.match(/(\d+)/);
            if (numMatch) {
                return parseInt(numMatch[1]);
            }
            
            return null;
        }

        function extractEquipment(recipeJson) {
            const equipment = [];
            const text = (recipeJson.description || '') + ' ' + JSON.stringify(recipeJson.recipeInstructions || []);
            
            const equipmentKeywords = {
                'Instant Pot': ['instant pot', 'pressure cooker'],
                'Cast Iron': ['cast iron', 'skillet'],
                'Stand Mixer': ['stand mixer', 'kitchenaid'],
                'Air Fryer': ['air fryer'],
                'Sous Vide': ['sous vide'],
                'Pizza Oven': ['pizza oven']
            };
            
            for (const [equipment_name, keywords] of Object.entries(equipmentKeywords)) {
                if (keywords.some(keyword => text.toLowerCase().includes(keyword))) {
                    equipment.push(equipment_name);
                }
            }
            
            return equipment;
        }

        function formatInstructions(instructions) {
            if (typeof instructions === 'string') {
                return instructions;
            }
            
            if (Array.isArray(instructions)) {
                return instructions.map(instruction => {
                    if (typeof instruction === 'string') {
                        return instruction;
                    } else if (instruction.text) {
                        return instruction.text;
                    } else if (instruction['@type'] === 'HowToStep') {
                        return instruction.text || instruction.name || '';
                    } else if (instruction['@type'] === 'HowToSection') {
                        const sectionSteps = instruction.itemListElement || [];
                        return sectionSteps.map(step => step.text || step.name || '').join(' ');
                    }
                    return JSON.stringify(instruction);
                }).filter(Boolean).join('\n\n');
            }
            
            return '';
        }

        function showImportStatus(message, type) {
            const statusDiv = document.getElementById('import-status');
            const messageDiv = document.getElementById('import-message');
            
            statusDiv.classList.remove('hidden');
            messageDiv.textContent = message;
            
            // Reset classes
            statusDiv.classList.remove('bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200', 'bg-blue-50', 'border-blue-200');
            messageDiv.classList.remove('text-red-800', 'text-green-800', 'text-blue-800');
            
            if (type === 'error') {
                statusDiv.classList.add('bg-red-50', 'border-red-200');
                messageDiv.classList.add('text-red-800');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-50', 'border-green-200');
                messageDiv.classList.add('text-green-800');
            } else {
                statusDiv.classList.add('bg-blue-50', 'border-blue-200');
                messageDiv.classList.add('text-blue-800');
            }
        }

        function showRecipePreview(recipe) {
            const previewContent = document.getElementById('preview-content');
            
            previewContent.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <h5 class="font-medium text-gray-800">${recipe.title}</h5>
                        <p class="text-sm text-gray-600">${recipe.description}</p>
                    </div>
                    
                    ${recipe.servings ? `<div class="text-sm"><strong>Serves:</strong> ${recipe.servings}</div>` : ''}
                    ${recipe.prepTime ? `<div class="text-sm"><strong>Prep:</strong> ${recipe.prepTime} minutes</div>` : ''}
                    ${recipe.cookingTime ? `<div class="text-sm"><strong>Cook:</strong> ${recipe.cookingTime} minutes</div>` : ''}
                    
                    <div>
                        <strong class="text-sm">Ingredients (${recipe.ingredients.length}):</strong>
                        <div class="text-sm text-gray-600 max-h-24 overflow-y-auto">
                            ${recipe.ingredients.slice(0, 5).map(ing => `• ${ing}`).join('<br>')}
                            ${recipe.ingredients.length > 5 ? `<br>... and ${recipe.ingredients.length - 5} more` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <strong class="text-sm">Instructions:</strong>
                        <div class="text-sm text-gray-600 max-h-24 overflow-y-auto">
                            ${recipe.instructions.substring(0, 200)}...
                        </div>
                    </div>
                </div>
            `;
        }

        function saveImportedRecipe() {
            if (importedRecipeData) {
                addRecipe(importedRecipeData);
                hideAddRecipeModal();
                showImportStatus('Recipe saved successfully!', 'success');
            }
        }

        function editImportedRecipe() {
            if (importedRecipeData) {
                // Switch to manual tab and populate fields
                showImportTab('manual');
                
                // Fill the manual form with imported data
                document.getElementById('recipe-name').value = importedRecipeData.title;
                document.getElementById('recipe-description').value = importedRecipeData.description;
                document.getElementById('recipe-ingredients').value = importedRecipeData.ingredients.join('\n');
                document.getElementById('recipe-instructions').value = importedRecipeData.instructions;
                document.getElementById('recipe-time').value = importedRecipeData.cookingTime;
                document.getElementById('recipe-energy').value = importedRecipeData.energyLevel;
                
                // Check equipment boxes
                importedRecipeData.equipment.forEach(eq => {
                    const checkbox = document.querySelector(`input[value="${eq}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Initialize auth UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for API to initialize
            setTimeout(() => {
                if (window.mealPlannerAPI) {
                    const user = window.mealPlannerAPI.getCurrentUser();
                    updateAuthUI(user);
                } else {
                    console.error('MealPlannerAPI not loaded');
                }
            }, 1000);
        });
    </script>
</body>
</html>